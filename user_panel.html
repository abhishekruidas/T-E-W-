
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles (All background colors are now black) --- */
        :root {
            --primary-bg: #000000; /* Black */
            --secondary-bg: #000000; /* Black */
            --card-bg: #000000; /* Black */
            --text-primary: #E2E8F0; /* Light gray for primary text */
            --text-secondary: #94A3B8; /* Muted gray for secondary text */
            --accent-color: #FACC15; /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue for primary actions */
            --border-color: #334155; /* Border color */
            --bottom-nav-bg: #000000; /* Black */
            --success-color: #10B981; /* Green for success */
            --danger-color: #EF4444; /* Red for danger/errors */
            --warning-color: #F59E0B; /* Orange for warnings */
            --info-color: #3B82F6; /* Blue for info */
        }
        /* ... (Rest of the CSS styles remain exactly the same) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); color: var(--text-primary); padding-top: 70px; padding-bottom: 75px; min-height: 100vh; overscroll-behavior-y: contain; }
        a { color: var(--accent-color); text-decoration: none; } a:hover { color: #FBBF24; }
        .main-content { padding: 15px; } .section { display: none; animation: fadeIn 0.3s ease-in-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); } .custom-card { background-color: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); } .btn-custom { border-radius: 6px; font-size: 0.9rem; font-weight: 500; padding: 8px 15px; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.2s ease, filter 0.2s ease; } .btn-custom-primary { background-color: var(--primary-button-bg); color: var(--text-primary); } .btn-custom-primary:hover { background-color: #2563EB; } .btn-custom-secondary { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .btn-custom-secondary:hover { background-color: #334155; } .btn-custom-accent { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .btn-custom-accent:hover { filter: brightness(1.1); } .btn-custom-link { background: none; border: none; color: var(--primary-button-bg); font-size: 0.9rem; font-weight: 500; padding: 0; cursor: pointer; } .text-accent { color: var(--accent-color); } .text-success { color: var(--success-color); } .text-danger { color: var(--danger-color); } .text-warning { color: var(--warning-color); } .form-control { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; } .form-control:focus { background-color: var(--primary-bg); border-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); } .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; } .form-label { color: var(--text-secondary); font-size: 0.9rem; } .alert { border-radius: 6px; font-size: 0.9rem; } .list-group-item { background-color: var(--card-bg); color: var(--text-primary); border: none; border-bottom: 1px solid var(--border-color); padding: 15px; font-size: 0.95rem; transition: background-color 0.2s ease; } .list-group-item:hover { background-color: rgba(255, 255, 255, 0.05); } .list-group-item:last-child { border-bottom: none; } .list-group-item i:first-child { color: var(--accent-color); margin-right: 15px; font-size: 1.1rem; width: 20px; text-align: center; } .list-group-item .bi-chevron-right { color: var(--text-secondary); font-size: 0.9rem; } #globalLoaderEl { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10001; display: none; } .spinner-border { color: var(--accent-color); width: 3rem; height: 3rem; } .placeholder-glow .placeholder { background-color: rgba(51, 65, 85, 0.5); animation: placeholder-glow 2s ease-in-out infinite; } .placeholder { background-color: rgba(51, 65, 85, 0.5); border-radius: 4px; } @keyframes placeholder-glow { 0% { background-color: rgba(51, 65, 85, 0.5); } 50% { background-color: rgba(51, 65, 85, 0.7); } 100% { background-color: rgba(51, 65, 85, 0.5); } } .interactive-list-item { cursor: pointer; } .referral-code { font-family: monospace; letter-spacing: 1px; user-select: all; } .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-bottom: 1px solid var(--border-color); } .header-left { display: flex; align-items: center; gap: 10px; } .header-logo { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color); } .header-title { font-size: 0.9rem; font-weight: 500; line-height: 1.2; } .header-title span { font-size: 0.75rem; color: var(--text-secondary); display: block; } .header-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; margin-right: 5px; display: none; padding: 5px; } .header-right { display: flex; align-items: center; gap: 15px; } .notification-icon { font-size: 1.3rem; color: var(--text-primary); position: relative; background: none; border: none; padding: 0; } .notification-badge { position: absolute; top: -3px; right: -5px; background-color: var(--danger-color); color: white; font-size: 0.6rem; width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; } .wallet-chip { background: var(--accent-gradient); color: var(--primary-bg); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; font-size: 0.85rem; font-weight: 700; border: none; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); cursor: pointer; } .wallet-chip i { margin-right: 5px; font-size: 0.9rem; } .header-game-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 10px; display: none; } .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--bottom-nav-bg); display: flex; justify-content: space-around; align-items: stretch; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-top: 1px solid var(--border-color); } .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; flex-grow: 1; padding: 8px 0; transition: color 0.2s ease, background-color 0.2s ease; border: none; background: none; cursor: pointer; font-size: 0.7rem; border-radius: 8px; margin: 4px; } .nav-item i { font-size: 1.4rem; margin-bottom: 4px; line-height: 1; } .nav-item span { font-size: 0.7rem; font-weight: 500; line-height: 1; } .nav-item.active { color: var(--accent-color); background-color: rgba(250, 204, 21, 0.1); } .swiper-container#promotionSliderEl { width: 100%; height: 200px; border-radius: 10px; margin-bottom: 25px; --swiper-pagination-color: var(--accent-color); --swiper-pagination-bullet-inactive-color: var(--text-secondary); --swiper-pagination-bullet-size: 8px; } .swiper-slide { background-color: var(--secondary-bg); border-radius: 10px; } .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; } .game-card { text-align: center; background-color: var(--card-bg); border-radius: 8px; overflow: hidden; padding: 0; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; } .game-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); } .game-card img { width: 100%; height: 130px; object-fit: cover; display: block; } .game-card span { display: block; padding: 10px 5px; font-weight: 500; font-size: 0.9rem; color: var(--text-primary); } .tournament-tabs { display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; } .tab-item { color: var(--text-secondary); background: none; border: none; padding: 8px 10px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; flex-grow: 1; text-align: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; } .tab-item.active { background-color: var(--primary-button-bg); color: var(--text-primary); } .tab-item i { margin-right: 5px; } .tournament-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); transition: transform 0.2s ease, box-shadow 0.2s ease; } .tournament-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); } .tournament-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; } .tournament-card-tags span { background-color: var(--primary-bg); color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; padding: 3px 8px; border-radius: 4px; display: inline-block; border: 1px solid var(--border-color); margin-right: 4px; margin-bottom: 4px; } .tournament-card-timer { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 4px; } .tournament-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); } .tournament-card-title i { color: var(--accent-color); } .tournament-card-info { display: flex; justify-content: space-between; align-items: stretch; border-top: 1px dashed var(--border-color); border-bottom: 1px dashed var(--border-color); padding: 10px 0; margin: 10px 0; font-size: 0.8rem; } .info-item { text-align: center; flex: 1; padding: 0 5px; } .info-item span { display: block; color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px; } .info-item strong { color: var(--text-primary); font-weight: 600; font-size: 0.9rem; } .info-item .prize-icon { color: var(--accent-color); font-size: 1.2rem; } .tournament-card-spots { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px; } .tournament-card-spots span { font-weight: 600; } .progress { height: 6px; background-color: var(--primary-bg); border-radius: 3px; overflow: hidden; } .progress-bar { background-color: var(--warning-color); transition: width 0.3s ease; } .tournament-card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; } .tournament-card-actions .btn-sm { padding: 8px 10px; font-size: 0.85rem; width: 100%; } .tournament-card-actions .btn-join { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; grid-column: 2 / 3; } .tournament-card-actions .btn-details { background-color: var(--secondary-bg); border: 1px solid var(--border-color); grid-column: 1 / 2; } .tournament-card-actions .btn-joined { background-color: var(--success-color); color: var(--text-primary); opacity: 0.8; grid-column: 2 / 3; } .tournament-card-actions .btn-disabled { background-color: var(--secondary-bg); opacity: 0.6; cursor: not-allowed; grid-column: 2 / 3; } .btn-idpass { background: var(--accent-gradient); color: var(--primary-bg); border: none; font-weight: 600; } .wallet-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color); } .wallet-card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 25px; } .balance-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); } .balance-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; } .balance-item-label { font-size: 0.95rem; color: var(--text-secondary); } .balance-item-value { font-size: 1.1rem; font-weight: 600; } .balance-item-action { min-width: 100px; text-align: right; } .balance-item-action .btn-custom-link { font-size: 0.85rem; color: var(--accent-color); padding: 5px; } .balance-item-action .btn-withdraw { background-color: var(--primary-button-bg); color: #fff; font-size: 0.8rem; padding: 5px 12px; border-radius: 5px; border: none; } #recentTransactionsListEl .custom-card { background-color: var(--secondary-bg); }
        /* --- Gemini: Added style for wallet action buttons --- */
        .wallet-actions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .leaderboard-list { list-style: none; padding: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 12px; background-color: var(--secondary-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        .leaderboard-rank { font-size: 1.1rem; font-weight: 700; color: var(--text-secondary); width: 40px; text-align: center; flex-shrink: 0; }
        .leaderboard-rank.rank-1 { color: #FFD700; } .leaderboard-rank.rank-2 { color: #C0C0C0; } .leaderboard-rank.rank-3 { color: #CD7F32; }
        .leaderboard-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin: 0 15px; border: 2px solid var(--border-color); }
        .leaderboard-info { flex-grow: 1; }
        .leaderboard-name { font-weight: 600; font-size: 0.95rem; color: var(--text-primary); }
        .leaderboard-score { font-size: 0.85rem; color: var(--text-secondary); }
        .leaderboard-score strong { color: var(--accent-color); font-weight: 700; }
        .profile-header-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); } .profile-avatar { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--accent-color); object-fit: cover; background-color: var(--primary-bg); } .profile-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; } .profile-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px; word-break: break-all; } .profile-stats { display: flex; justify-content: space-around; width: 100%; border-top: 1px solid var(--border-color); padding-top: 15px; } .stat-item { text-align: center; flex: 1; } .stat-item strong { display: block; font-size: 1rem; font-weight: 600; } .stat-item span { font-size: 0.75rem; color: var(--text-secondary); } .profile-links .list-group { border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); } .profile-links .form-switch .form-check-input { background-color: var(--secondary-bg); border-color: var(--border-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e"); } .profile-links .form-switch .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); } #login-section { margin-top: 5vh; } #login-section .card { background-color: var(--card-bg); border: 1px solid var(--border-color); } #login-section .btn-primary { background-color: var(--primary-button-bg); border: none; } #login-section .btn-link { background: none; border: none; color: var(--accent-color); text-decoration: none; font-size: 0.9em; padding: 5px 0; } #login-section .btn-link:hover { text-decoration: underline; } #login-section .btn-success { background-color: var(--success-color); border: none; } #login-section .btn-danger { background-color: var(--danger-color); border: none; } #login-section .form-divider { text-align: center; margin: 20px 0; position: relative; color: var(--text-secondary); } #login-section .form-divider::before, #login-section .form-divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background-color: var(--border-color); } #login-section .form-divider::before { left: 0; } #login-section .form-divider::after { right: 0; } #login-section .form-divider span { background-color: var(--card-bg); padding: 0 10px; position: relative; z-index: 1; font-size: 0.8rem; font-weight: 500; } #login-section .card-title { color: var(--text-primary); } #googleSignInBtnMainEl { display: none; } .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .modal-header { border-bottom-color: var(--border-color); } .modal-footer { border-top-color: var(--border-color); } .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } .modal-body .phonepe-number { color: var(--warning-color); font-weight: bold; user-select: text; } #matchDetailsModalBodyEl pre { background-color: var(--primary-bg); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; } #policyModalBodyEl { line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; } #idPasswordModalEl .copy-btn { padding: 2px 6px; font-size: 0.8rem; margin-left: 8px; vertical-align: middle; } #policyModalBodyEl .copy-btn, #policyModalBodyEl #shareReferralBtn { padding: 4px 10px; font-size: 0.9rem; } #policyModalBodyEl #shareReferralBtn i, #policyModalBodyEl .copy-btn i { margin-right: 5px; } #securityWarning { background-color: var(--danger-color); color: white; padding: 10px 15px; text-align: center; font-size: 0.9rem; position: sticky; top: 60px; z-index: 999; border-bottom: 1px solid #a51d1d; } #securityWarning a { color: #ffdddd; text-decoration: underline; } #securityWarning button { background: none; border: 1px solid white; color: white; padding: 2px 8px; margin-left: 15px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }

        /* --- Updated: Seat Selection Modal Styles --- */
        .seat-grid {
            display: flex; /* Changed to flex for wrapping teams */
            flex-wrap: wrap; /* Allow teams to wrap to the next line */
            gap: 10px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--primary-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .team-box {
            display: flex;
            gap: 5px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: rgba(0,0,0,0.1);
        }
        .team-box.partial {
            border-color: var(--warning-color);
        }
        .team-box.full {
            border-color: var(--danger-color);
            opacity: 0.7;
        }
        .seat-box {
            display: flex;
            flex-direction: column; /* Allow IGN to be below */
            justify-content: center;
            align-items: center;
            width: 55px; /* Fixed width */
            height: 55px; /* Fixed height */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, border-color 0.2s;
            position: relative; /* For IGN positioning */
            font-size: 1rem;
        }
        .seat-box:hover:not(.taken):not(.selected) {
            background-color: #334155;
        }
        .seat-box.taken {
            background-color: var(--danger-color);
            color: var(--text-primary);
            cursor: not-allowed;
        }
        .seat-box .player-ign {
            font-size: 0.6rem;
            position: absolute;
            bottom: 2px;
            left: 0;
            right: 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 2px;
            color: var(--text-primary);
        }

        .seat-box.selected {
            background-color: var(--success-color);
            color: var(--primary-bg);
            border-color: var(--success-color);
        }
        
        /* --- Gemini: এখানে ব্যবহারকারীর নিজের সিটের জন্য স্টাইল যোগ করা হয়েছে --- */
        .seat-box.my-seat {
            background-color: var(--primary-button-bg);
            border: 2px solid var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }

        /* --- Gemini: শুধুমাত্র দেখার মোডে নির্দিষ্ট অংশ লুকানোর জন্য --- */
        .modal.view-only #teamMemberSelectionEl,
        .modal.view-only #seatSelectionHelperTextEl,
        .modal.view-only #confirmSeatSelectionBtnEl,
        .modal.view-only #seatSelectionStatusMessageEl {
            display: none;
        }
        .modal.view-only .seat-box:not(.taken) {
            cursor: default; /* শুধুমাত্র খালি সিটের কার্সার পরিবর্তন হবে */
        }
        .modal.view-only .seat-box:hover:not(.taken):not(.selected) {
            background-color: transparent; /* হোভার এফেক্ট বন্ধ করা হলো */
        }


        /* --- Updated: Add Amount Modal Style --- */
        #addAmountOptionsContainerEl {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        /* Google button icon color */
        .btn-custom i.fa-google {
            color: #DB4437;
        }
        
        /* --- Gemini: সমস্ত বাটনে শ্যাডো ইফেক্ট যোগ করা হয়েছে (আপনার অনুরোধ অনুযায়ী) --- */

        /* Password Toggle Button */
        .password-wrapper {
            position: relative;
        }
        .password-toggle-btn {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            z-index: 3;
        }
        .password-toggle-btn:hover {
            color: var(--accent-color);
        }
        .password-toggle-btn i {
            font-size: 1.1rem;
        }

        /* Smooth Transitions for all interactive elements */
        .btn-custom, .nav-item, .game-card, .tournament-card, .list-group-item, .tab-item, .wallet-chip, .profile-header-card, .leaderboard-item, .wallet-card, .notification-icon, .copy-btn {
            transition: transform 0.2s ease-out, box-shadow 0.3s ease-out, filter 0.2s ease-out;
        }

        /* 3D Button Press Effect */
        .btn-custom:active, .nav-item:active, .tab-item:active, .wallet-chip:active {
            transform: scale(0.96) translateY(2px);
            filter: brightness(0.9);
        }

        /* Base Shadow for Cards */
        .custom-card, .game-card, .tournament-card, .leaderboard-item {
             box-shadow: 0 2px 5px rgba(0,0,0,0.2), 0 0 2px rgba(0,0,0,0.1);
        }

        /* Live Shadow Animation Keyframes */
        @keyframes liveShadowGlow {
            0%   { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 15px rgba(59, 130, 246, 0.4), 0 0 8px rgba(239, 68, 68, 0.3); } /* Blue + Red */
            25%  { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 15px rgba(239, 68, 68, 0.4), 0 0 8px rgba(16, 185, 129, 0.3); } /* Red + Green */
            50%  { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 15px rgba(16, 185, 129, 0.4), 0 0 8px rgba(250, 204, 21, 0.3); } /* Green + Yellow */
            75%  { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 15px rgba(250, 204, 21, 0.4), 0 0 8px rgba(59, 130, 246, 0.3); } /* Yellow + Blue */
            100% { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 15px rgba(59, 130, 246, 0.4), 0 0 8px rgba(239, 68, 68, 0.3); } /* Blue + Red (Loop) */
        }

        /* Applying lift effect on hover */
        .tournament-card:hover,
        .game-card:hover,
        .leaderboard-item:hover,
        .profile-header-card:hover,
        .wallet-card:hover,
        .list-group-item.interactive-list-item:hover {
           transform: translateY(-5px); /* Lifts the cards on hover */
        }

        .btn-custom:hover,
        .tab-item:hover,
        .wallet-chip:hover,
        .nav-item:hover,
        .notification-icon:hover,
        .copy-btn:hover {
           transform: translateY(-2px); /* Lifts the buttons slightly */
        }

        /* Applying the animation on hover to all interactive elements */
        .tournament-card:hover,
        .game-card:hover,
        .leaderboard-item:hover,
        .list-group-item.interactive-list-item:hover,
        .profile-header-card:hover,
        .wallet-card:hover,
        .btn-custom:hover,
        .tab-item:hover,
        .wallet-chip:hover,
        .nav-item:hover,
        .notification-icon:hover,
        .copy-btn:hover {
           animation: liveShadowGlow 4s infinite linear;
        }

        /* Adding subtle animation to the active bottom nav item icon */
        .nav-item.active i {
            animation: bounceIcon 0.6s ease-in-out;
        }
        @keyframes bounceIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* Leaderboard tabs styling */
        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: 1px solid transparent;
            border-bottom-color: var(--border-color);
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: var(--accent-color);
            background-color: rgba(51, 65, 85, 0.3);
            border-color: var(--border-color);
            border-bottom-color: transparent;
            font-weight: 700;
        }
        .nav-tabs {
            border-bottom-color: var(--border-color);
        }

    </style>
</head>

<body>
     <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo" id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> Welcome <span id="headerUserGreetingEl">Guest</span> </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i class="bi bi-wallet-fill"></i> ₹<span id="headerChipBalanceEl">0</span> </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl"> <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> </div>

        <!-- Login Section -->
        <section id="login-section" class="section">
             <div class="container" style="max-width: 450px;">
                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3">
                                <label for="loginPasswordInputEl" class="form-label">Password</label>
                                <div class="password-wrapper">
                                    <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required>
                                    <button type="button" class="password-toggle-btn" aria-label="Toggle password visibility"><i class="bi bi-eye-slash"></i></button>
                                </div>
                            </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Sign Up</h2>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3">
                                <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label>
                                <div class="password-wrapper">
                                    <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required minlength="6">
                                    <button type="button" class="password-toggle-btn" aria-label="Toggle password visibility"><i class="bi bi-eye-slash"></i></button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label>
                                <div class="password-wrapper">
                                    <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required>
                                    <button type="button" class="password-toggle-btn" aria-label="Toggle password visibility"><i class="bi bi-eye-slash"></i></button>
                                </div>
                            </div>
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>

                        <!-- Social Login -->
                        <div class="form-divider"><span>OR</span></div>
                        <div class="d-grid">
                            <button type="button" class="btn btn-custom btn-custom-secondary" id="googleSignInBtnEl">
                                <i class="fab fa-google"></i> Sign in with Google
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                 </div>
                 <div class="swiper-pagination"></div>
            </div>
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div> <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
            </div>
            <h2 class="section-title">My Active Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>
        
        <!-- My Contests Section -->
        <section id="my-contests-section" class="section">
            <h2 class="section-title">All My Contests</h2>
            <p class="text-secondary mb-3">All tournaments you have joined (Upcoming, Ongoing, and Completed).</p>
            <div id="myContestsSectionListEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div>
            </div>
             <p id="noMyContestsMessageEl" class="text-secondary text-center mt-4" style="display: none;">You haven't joined any contests yet.</p>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboard-section" class="section">
            <h2 class="section-title">Leaderboard</h2>
            <!-- নতুন ট্যাব যোগ করা হয়েছে -->
            <ul class="nav nav-tabs nav-fill mb-3" id="leaderboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="weekly-tab" data-period="weekly" type="button" role="tab">Weekly</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monthly-tab" data-period="monthly" type="button" role="tab">Monthly</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-time-tab" data-period="all_time" type="button" role="tab">All Time</button>
                </li>
            </ul>
            
             <div id="leaderboard-list-el" class="placeholder-glow">
                <div class="leaderboard-item"><span class="placeholder col-1 me-3" style="height: 24px;"></span> <span class="placeholder rounded-circle" style="width: 45px; height: 45px;"></span> <div class="leaderboard-info ms-3 flex-grow-1"><span class="placeholder col-5 d-block" style="height: 20px;"></span><span class="placeholder col-3 d-block mt-1" style="height: 16px;"></span></div></div>
                <div class="leaderboard-item mt-2"><span class="placeholder col-1 me-3" style="height: 24px;"></span> <span class="placeholder rounded-circle" style="width: 45px; height: 45px;"></span> <div class="leaderboard-info ms-3 flex-grow-1"><span class="placeholder col-5 d-block" style="height: 20px;"></span><span class="placeholder col-3 d-block mt-1" style="height: 16px;"></span></div></div>
             </div>
             <p id="noLeaderboardMessageEl" class="text-secondary text-center mt-4" style="display: none;">Leaderboard data is not available yet.</p>
        </section>


        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">My Wallet</h2>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-withdraw btn-custom btn-custom-primary" id="withdrawBtnEl">Withdraw</button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action" style="min-width: 100px;"></div> </div>
                
                <!-- Gemini: Wallet action buttons -->
                <div class="wallet-actions">
                    <button class="btn btn-custom btn-custom-secondary" id="addAmountWalletBtnEl"> <i class="bi bi-plus-circle-fill"></i>Add Amount </button>
                    <button class="btn btn-custom btn-custom-secondary" id="sendToFriendBtnEl"> <i class="bi bi-send-fill"></i>Send to Friend </button>
                </div>
            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow"> <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div> <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> </div>
        </section>

        <!-- NEW: All Transactions Section -->
        <section id="transactions-section" class="section">
            <h2 class="section-title">Transaction History</h2>
            <p class="text-secondary mb-3">Your complete transaction history.</p>
            <div id="allTransactionsListEl" class="placeholder-glow">
                <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div>
                <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div>
            </div>
            <p class="text-secondary text-center mt-4" id="noAllTransactionsMessageEl" style="display: none;">No transactions found.</p>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow custom-card">
                <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl">
                <div class="d-flex align-items-center justify-content-center mt-2">
                    <h3 class="profile-name mb-0 me-2" id="profileNameEl"><span class="placeholder col-6"></span></h3>
                    <button id="editProfileNameBtnEl" class="btn btn-sm btn-custom-link p-0" style="font-size: 1.1rem; line-height: 1;"><i class="bi bi-pencil-square"></i></button>
                </div>
                <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div class="profile-stats w-100">
                    <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div>
                    <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div>
                    <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div>
                </div>
            </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"> <span><i class="bi bi-bell-fill"></i> Notifications</span> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked> </div> </label>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span> </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    
    <div class="modal fade" id="addAmountModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> How to Add Amount?</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <p class="text-secondary text-center small">Select an amount to pay</p>
        <div id="addAmountOptionsContainerEl" class="my-3">
            <p class="text-secondary text-center small">Loading options...</p>
        </div>
        <div id="qrSection" style="display: none;">
            <hr style="border-color: var(--border-color);">
            <h6 class="text-light text-center mt-3">Pay <strong id="selectedAmountDisplay" class="text-accent"></strong> via UPI</h6>
            <p class="text-center text-warning" style="user-select: all;"><strong>UPI ID:</strong> <span id="upiIdDisplay">N/A</span></p>
            <div class="text-center mb-3">
                <canvas id="qrCanvasDisplay" style="width: 200px; height: 200px; border-radius: 10px; border: 2px solid var(--border-color); padding: 5px; background: white;"></canvas>
            </div>
            <div class="mb-3">
                <label for="paymentScreenshotInput" class="form-label">Upload Payment Screenshot</label>
                <input type="file" class="form-control" id="paymentScreenshotInput" accept="image/*" required>
            </div>
            <div id="paymentStatusMessageEl" class="mt-2"></div>
            <div class="d-grid">
                <button type="button" class="btn btn-custom btn-custom-primary" id="submitPaymentBtnEl">Submit for Verification</button>
            </div>
        </div>
    </div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>

    <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">₹0.00</strong></p><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min ₹<span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method (UPI/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter UPI ID / Bank Details"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div>
    
    <!-- Gemini: Send to Friend Modal -->
    <div class="modal fade" id="sendToFriendModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-send-fill me-2"></i> Send Winning Cash</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary">Your available winning cash: <strong class="text-light" id="sendModalBalanceEl">₹0.00</strong></p>
                    <div class="mb-3">
                        <label for="sendFriendCodeInputEl" class="form-label">Friend's Referral Code</label>
                        <input type="text" class="form-control" id="sendFriendCodeInputEl" placeholder="Enter referral code">
                    </div>
                    <div class="mb-3">
                        <label for="sendAmountInputEl" class="form-label">Amount to Send</label>
                        <input type="number" class="form-control" id="sendAmountInputEl" placeholder="Enter amount">
                    </div>
                    <div id="sendToFriendStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-accent" id="confirmSendToFriendBtnEl">Confirm & Send</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div>
    
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Room ID & Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="small text-secondary">ID/Pass shown shortly before match start.</p>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Room ID:</p>
                        <h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4>
                        <button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Password:</p>
                        <h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4>
                        <button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button>
                    </div>

                    <!-- Gemini: এখানে রুমের ফটো বা QR কোড দেখানোর জন্য নতুন কোড যোগ করা হয়েছে -->
                    <div id="roomIdPassImageContainerEl" class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px; display: none;">
                        <p class="mb-2">Room Image / QR Code:</p>
                        <img id="roomIdPassImageEl" src="" alt="Room Details Image" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid var(--border-color);">
                    </div>
                    
                    <p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- UPDATED: Team Join / Seat Selection Modal -->
    <div class="modal fade" id="seatSelectionModalEl" tabindex="-1" aria-labelledby="seatSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="seatSelectionModalLabel">Team & Seat Selection</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Player Count and IGN Inputs -->
                    <div id="teamMemberSelectionEl" class="mb-3"></div>
                    
                    <p class="text-secondary small" id="seatSelectionHelperTextEl">Please select seats for your team.</p>
                    
                    <!-- Seat grid -->
                    <div id="seatSelectionGridEl" class="seat-grid">
                        <!-- Seat boxes will be dynamically inserted here -->
                    </div>

                    <div id="seatSelectionStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-accent" id="confirmSeatSelectionBtnEl">Confirm & Join</button>
                </div>
            </div>
        </div>
    </div>


    <!-- MODIFIED: Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="my-contests-section"><i class="bi bi-controller"></i><span>My Contests</span></button>
        <button class="nav-item" data-section="leaderboard-section"><i class="bi bi-trophy-fill"></i><span>Leaderboard</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>


    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp, startAt } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // --- Bengali Comment: এখানে আপনার Firebase প্রজেক্টের কনফিগারেশন কী (keys) যোগ করুন। ---
        const firebaseConfig = {
            apiKey: "AIzaSyCS7BmpygtRQnTmiZG3cZO7axT8ATEdlZM",
            authDomain: "tew-app-d41bc.firebaseapp.com",
            databaseURL: "https://tew-app-d41bc-default-rtdb.firebaseio.com",
            projectId: "tew-app-d41bc",
            storageBucket: "tew-app-d41bc.appspot.com",
            messagingSenderId: "559946715130",
            appId: "1:559946715130:web:2e9bac64a5ee8774a15e43"
        };
        
        const IMGBB_API_KEY = '365d26783295502392e20f2b372e721c';

        // Initialize Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

        // --- DOM Elements Cache ---
         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
             loginSection: getElement('login-section'),
             emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             emailSignupForm: getElement('emailSignupForm'), signupEmailInput: getElement('signupEmailInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'),
             googleSignInBtn: getElement('googleSignInBtnEl'),
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             sendToFriendBtn: getElement('sendToFriendBtnEl'), // Gemini: New button
             transactionsSection: getElement('transactions-section'), allTransactionsList: getElement('allTransactionsListEl'), noAllTransactionsMessage: getElement('noAllTransactionsMessageEl'),
             myContestsSection: getElement('my-contests-section'), myContestsSectionList: getElement('myContestsSectionListEl'), noMyContestsMessage: getElement('noMyContestsMessageEl'),
             leaderboardSection: getElement('leaderboard-section'), leaderboardList: getElement('leaderboard-list-el'), noLeaderboardMessage: getElement('noLeaderboardMessageEl'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             editProfileNameBtn: getElement('editProfileNameBtnEl'), 
             // Modals
             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, addAmountOptionsContainer: getElement('addAmountOptionsContainerEl'), qrSection: getElement('qrSection'), selectedAmountDisplay: getElement('selectedAmountDisplay'), upiIdDisplay: getElement('upiIdDisplay'), qrCanvasDisplay: getElement('qrCanvasDisplay'), paymentScreenshotInput: getElement('paymentScreenshotInput'), paymentStatusMessage: getElement('paymentStatusMessageEl'), submitPaymentBtn: getElement('submitPaymentBtnEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             // Gemini: Send to Friend Modal Elements
             sendToFriendModalInstance: getElement('sendToFriendModalEl') ? new bootstrap.Modal(getElement('sendToFriendModalEl')) : null,
             sendModalBalance: getElement('sendModalBalanceEl'),
             sendFriendCodeInput: getElement('sendFriendCodeInputEl'),
             sendAmountInput: getElement('sendAmountInputEl'),
             sendToFriendStatusMessage: getElement('sendToFriendStatusMessageEl'),
             confirmSendToFriendBtn: getElement('confirmSendToFriendBtnEl'),
             matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, 
             roomIdDisplay: getElement('roomIdDisplayEl'), 
             roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             // Gemini: এখানে নতুন এলিমেন্টগুলো যোগ করা হয়েছে
             roomIdPassImageContainer: getElement('roomIdPassImageContainerEl'),
             roomIdPassImage: getElement('roomIdPassImageEl'),
             seatSelectionModalInstance: getElement('seatSelectionModalEl') ? new bootstrap.Modal(getElement('seatSelectionModalEl')) : null,
             seatSelectionModalLabel: getElement('seatSelectionModalLabel'),
             teamMemberSelection: getElement('teamMemberSelectionEl'),
             seatSelectionHelperText: getElement('seatSelectionHelperTextEl'),
             seatSelectionGrid: getElement('seatSelectionGridEl'),
             seatSelectionStatusMessage: getElement('seatSelectionStatusMessageEl'),
             confirmSeatSelectionBtn: getElement('confirmSeatSelectionBtnEl'),
             securityWarning: getElement('securityWarning')
         };

        // --- App State ---
        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let validReferrerUid = null; let currentPaymentSubmission = { amount: 0 };
        let qrInstance = null; 

        // --- Utility Functions ---
        const showLoader = (show) => { if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none'; };
        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type} mt-3`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        function copyToClipboard(targetSelector) { if (!targetSelector) { alert('Copy target not defined.'); return; } const targetElement = querySel(targetSelector); if (!targetElement) { alert('Element to copy from not found.'); return; } const textToCopy = targetElement.textContent; if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder')) { alert('Nothing to copy.'); return; } navigator.clipboard.writeText(textToCopy).then(() => alert('Copied!')).catch(err => { console.error('Failed to copy:', err); alert('Failed to copy.'); }); }
        
        // --- পরিবর্তিত ফাংশন: অ্যাডমিন প্যানেল থেকে আসা অ্যাপ লিংক ব্যবহার করবে ---
        function shareReferral(code) {
            if (!navigator.share) {
                alert('Web Share not supported. Copy the code manually.');
                return;
            }
            if (!code || code === 'N/A') {
                alert('Referral code not available.');
                return;
            }

            // অ্যাডমিন প্যানেল থেকে আসা লিংক ব্যবহার করা হবে, না থাকলে বর্তমান ওয়েবসাইটের লিংক ব্যবহৃত হবে
            const shareUrl = appSettings.appShareLink || window.location.origin;

            navigator.share({
                title: 'Join Me on Gaming Tournament!',
                text: `Join using my referral code: ${code} & get rewards! App: ${shareUrl}`,
                url: shareUrl // এখানে পরিবর্তিত লিংকটি ব্যবহৃত হচ্ছে
            }).catch((error) => console.log('Error sharing', error));
        }

        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting Soon'; const days = Math.floor(diff / 86400000); const hours = Math.floor((diff % 86400000) / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };
        
        function recalcProfileBalance(profile) {
            if (!profile) return profile;
            profile.winningCash = Number(profile.winningCash || 0);
            profile.bonusCash = Number(profile.bonusCash || 0);
            profile.balance = profile.winningCash + profile.bonusCash;
            return profile;
        }

        async function uploadToImgBB(file) {
            if (!file) throw new Error("File not selected.");
            if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_API_KEY_HERE') {
                throw new Error("ImgBB API Key not configured.");
            }
            const formData = new FormData();
            formData.append('image', file);
            
            showStatusMessage(elements.paymentStatusMessage, 'Uploading screenshot...', 'info', false);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Upload failed: ${errorData?.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error(`ImgBB returned an error: ${data.error?.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('ImgBB Upload Error:', error);
                throw error;
            }
        }


        // --- UI Functions ---
         function showSection(sectionId) {
             if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
             const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
             const protectedSections = ['home-section', 'wallet-section', 'profile-section', 'tournaments-section', 'my-contests-section', 'leaderboard-section', 'transactions-section'];
             const isLoggedIn = !!currentUser;
             
             if (protectedSections.includes(sectionId) && !isLoggedIn) {
                 showSection('login-section'); return; 
             }
             if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }

             elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
             updateHeaderForSection(sectionId);
             elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
             console.log(`Loading data for section: ${sectionId}`);
             switch (sectionId) {
                 case 'home-section': loadHomePageData(); break;
                 case 'wallet-section': loadWalletData(); break;
                 case 'transactions-section': loadAllTransactions(); break; // New case for history
                 case 'profile-section': loadProfileData(); break;
                 case 'my-contests-section': loadDedicatedMyContests(); break;
                 case 'leaderboard-section': 
                    loadLeaderboardData('weekly'); // ডিফল্ট সাপ্তাহিক লোড হবে
                    break;
                 case 'tournaments-section':
                    if(currentTournamentGameId) {
                         const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                         filterTournaments(currentTournamentGameId, activeTab);
                    } else {
                         elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>';
                    }
                    break;
             }
             if (sectionId === 'login-section') { toggleLoginForm(true); }
             window.scrollTo(0, 0);
         }

         function updateHeaderForSection(sectionId) {
             const showBackButton = ['tournaments-section', 'wallet-section', 'transactions-section'].includes(sectionId);
             const defaultTitleVisible = !showBackButton;
             let gameTitleVisible = false;
             let newTitle = '';

             if (sectionId === 'tournaments-section') {
                gameTitleVisible = true;
                newTitle = appSettings?.games?.[currentTournamentGameId]?.name || 'Tournaments';
             } else if (sectionId === 'wallet-section') {
                gameTitleVisible = true;
                newTitle = "Wallet";
             } else if (sectionId === 'transactions-section') {
                gameTitleVisible = true;
                newTitle = "Transaction History";
             }

             if (elements.headerBackBtn) {
                 elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
                 // Custom back button logic
                 if (sectionId === 'transactions-section') {
                    elements.headerBackBtn.onclick = () => showSection('wallet-section');
                 } else { // For wallet and tournaments, go back to home
                    elements.headerBackBtn.onclick = () => showSection('home-section');
                 }
             }
             if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
             if (elements.headerGameTitle) {
                elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';
                if(gameTitleVisible) elements.headerGameTitle.textContent = newTitle;
             }

             if (defaultTitleVisible && elements.headerUserGreeting) { 
                const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; 
                elements.headerUserGreeting.textContent = nameToShow; 
             }
         }

         function updateGlobalUI(isLoggedIn) {
             if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; }
             if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
             if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';
             elements.bottomNavItems.forEach(item => { 
                const section = item.dataset.section; 
                if(section !== 'home-section'){
                    item.style.display = isLoggedIn ? 'flex' : 'none';
                }
             });
         }
        
        /**
         * --- Bengali Comment for Developer ---
         * ব্যবহারকারীর প্রোফাইল তথ্য (যেমন Matches Played, Matches Won, Total Winnings) UI-তে দেখানোর জন্য এই ফাংশনটি সঠিক আছে।
         * যদি এই সংখ্যাগুলো '0' থেকে আপডেট না হয়, তার কারণ হলো ডাটাবেসে এই তথ্যগুলো আপডেট করার জন্য কোনো ব্যাকএন্ড লজিক (যেমন অ্যাডমিন প্যানেল বা ক্লাউড ফাংশন) নেই।
         * টুর্নামেন্টের ফলাফল ঘোষণার পর অবশ্যই 'users/{uid}/' পাথে 'totalMatches', 'wonMatches', এবং 'totalEarnings' আপডেট করতে হবে।
         * এই কোডে কোনো পরিবর্তনের প্রয়োজন নেই, সমস্যাটি ডাটাবেস আপডেটের।
         */
        function populateUserInfo(user, profile) {
            if (!user || !profile) return;

            // --- Data Preparation ---
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            const winningCash = Number(profile.winningCash || 0);
            const bonusCash = Number(profile.bonusCash || 0);
            const totalBalance = winningCash + bonusCash;
            const totalEarnings = Number(profile.totalEarnings || 0);
            const totalMatches = Number(profile.totalMatches || 0);
            const wonMatches = Number(profile.wonMatches || 0);
            const formatCurrency = (amount) => `₹${Number(amount || 0).toFixed(2)}`;

            // --- UI Population ---
            
            // Header & Global
            if(elements.appLogo) elements.appLogo.src = photoURL;
            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(totalBalance);

            // Wallet Section
            if (elements.walletTotalBalance) elements.walletTotalBalance.textContent = formatCurrency(totalBalance);
            if (elements.walletWinningCash) elements.walletWinningCash.textContent = formatCurrency(winningCash);
            if (elements.walletBonusCash) elements.walletBonusCash.textContent = formatCurrency(bonusCash);
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash);
            if (elements.sendModalBalance) elements.sendModalBalance.textContent = formatCurrency(winningCash);
            
            // Profile Section
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) elements.profileName.textContent = displayName;
            if (elements.profileEmail) elements.profileEmail.textContent = user.email || 'N/A';
            if (elements.profileTotalMatches) elements.profileTotalMatches.textContent = totalMatches;
            if (elements.profileWonMatches) elements.profileWonMatches.textContent = wonMatches;
            if (elements.profileTotalEarnings) elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings);

            // --- Placeholder Removal ---
            const profileCard = elements.profileName?.closest('.profile-header-card');
            if(profileCard) removePlaceholders(profileCard);
            
            const walletCard = elements.walletTotalBalance?.closest('.wallet-card');
            if(walletCard) {
                 if (elements.walletTotalBalance) removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
                 if (elements.walletWinningCash) removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
                 if (elements.walletBonusCash) removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
            }
        }

        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm) return;
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            elements.emailLoginForm.style.display = showLogin ? 'block' : 'none';
            elements.emailSignupForm.style.display = showLogin ? 'none' : 'block';
            elements.emailLoginForm.reset();
            elements.emailSignupForm.reset();
        }

        // --- Firebase Auth Functions ---
         async function signUpWithEmail() {
             if (!auth) return;
             const em = elements.signupEmailInput.value.trim();
             const pw = elements.signupPasswordInput.value;
             const cpw = elements.signupConfirmPasswordInput.value;
             const refCode = elements.signupReferralCodeInput.value.trim();

             if (!em || !pw || !cpw) { showStatusMessage(elements.signupStatusMessage, 'Fill required fields.', 'warning'); return; }
             if (pw !== cpw) { showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning'); return; }
             if (pw.length < 6) { showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning'); return; }

             showLoader(true); clearStatusMessage(elements.signupStatusMessage);
             validReferrerUid = null;

             try {
                 if (refCode) {
                     console.log("Validating referral code:", refCode);
                     const usersRef = ref(db, 'users');
                     const q = query(usersRef, orderByChild('referralCode'), equalTo(refCode));
                     const snapshot = await get(q);
                     if (snapshot.exists()) {
                         const referrerData = snapshot.val();
                         const referrerId = Object.keys(referrerData)[0];
                         const referrerProfile = referrerData[referrerId];
                         if (referrerId && referrerProfile.email) {
                             validReferrerUid = referrerId;
                             console.log("Valid referrer found:", validReferrerUid);
                         } else {
                             console.warn("Referral code found, but referrer data invalid:", referrerData);
                         }
                     } else {
                         console.log("Referral code not found:", refCode);
                     }
                 }
                 await createUserWithEmailAndPassword(auth, em, pw);
             } catch (e) {
                 console.error("Signup Error:", e); let m = `Signup failed.`; switch (e.code) { case 'auth/email-already-in-use': m = 'Email already registered.'; break; case 'auth/weak-password': m = 'Password too weak.'; break; case 'auth/invalid-email': m = 'Invalid email.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.signupStatusMessage, m, 'danger');
             } finally {
                 showLoader(false);
             }
         }
         async function loginWithEmail() {
             if (!auth) return;
             const em = elements.loginEmailInput.value.trim();
             const pw = elements.loginPasswordInput.value;
             if (!em || !pw) { showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning'); return; }
             showLoader(true); clearStatusMessage(elements.loginStatusMessage);
             try { await signInWithEmailAndPassword(auth, em, pw); }
             catch (e) { console.error("Login Error:", e); let m = `Login failed.`; switch (e.code) { case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password.'; break; case 'auth/invalid-email': m = 'Invalid email format.'; break; case 'auth/too-many-requests': m = 'Too many attempts. Reset pass or wait.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; case 'auth/user-disabled': m = 'Account disabled.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
             finally { showLoader(false); }
         }
        
         async function signInWithGoogle() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            showLoader(true);
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest.
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                let m = `Google Sign-In failed.`;
                switch (error.code) {
                    case 'auth/popup-closed-by-user': m = 'Sign-in window was closed.'; break;
                    case 'auth/account-exists-with-different-credential': m = 'An account already exists with this email. Please sign in using the original method.'; break;
                    default: m = `Error: ${error.message}`;
                }
                showStatusMessage(elements.loginStatusMessage, m, 'danger');
            } finally {
                showLoader(false);
            }
        }

         async function resetPassword() {
             if (!auth) return;
             const em = elements.loginEmailInput.value.trim();
             if (!em) { showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset.', 'warning'); return; }
             showLoader(true); clearStatusMessage(elements.loginStatusMessage);
             try { await sendPasswordResetEmail(auth, em); showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false); }
             catch (e) { console.error("Reset Pass Error:", e); let m = `Failed to send email.`; switch (e.code) { case 'auth/user-not-found': case 'auth/invalid-email': m = 'Email not found.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
             finally { showLoader(false); }
         }
         async function logoutUser() { if (!auth) return; try { showLoader(true); await signOut(auth); } catch (e) { console.error("Sign Out Error:", e); alert(`Logout failed: ${e.message}`); showLoader(false); } }

        // --- Auth State Change Handler ---
         async function handleAuthStateChange(user) {
             if (!auth || !db) { console.error("Firebase not ready in auth change"); showLoader(false); return; }
             showLoader(true); detachAllDbListeners(); currentUser = user;
             const localReferrerUid = validReferrerUid;
             validReferrerUid = null;

             if (user) {
                 console.log("Auth State: Logged In", user.uid); const userRef = ref(db, 'users/' + user.uid);
                 try {
                     const snapshot = await get(userRef);
                     if (snapshot.exists()) {
                         userProfile = snapshot.val(); const updates = {};
                         if (user.displayName && (!userProfile.displayName || userProfile.displayName !== user.displayName)) updates.displayName = user.displayName;
                         if (user.photoURL && (!userProfile.photoURL || userProfile.photoURL !== user.photoURL)) updates.photoURL = user.photoURL;
                         if (user.email && !userProfile.email) updates.email = user.email;
                         if (Object.keys(updates).length > 0) { 
                             await update(userRef, updates); 
                             userProfile = { ...userProfile, ...updates }; 
                        }
                     } else {
                         console.log("New user, creating profile...");
                         const newUserProfile = {
                             uid: user.uid,
                             displayName: user.displayName || user.email?.split('@')[0] || 'User',
                             email: user.email || null,
                             photoURL: user.photoURL || null,
                             balance: (appSettings.newUserBalance || 0) + (appSettings.newUserBonus || 0),
                             winningCash: appSettings.newUserBalance || 0,
                             bonusCash: appSettings.newUserBonus || 0,
                             totalMatches: 0,
                             wonMatches: 0,
                             totalEarnings: 0,
                             referralEarnings: 0,
                             createdAt: serverTimestamp(),
                             referralCode: generateReferralCode(),
                             joinedTournaments: {},
                             isAdmin: false,
                             ...(localReferrerUid ? { referredBy: localReferrerUid } : {})
                         };
                         await set(userRef, newUserProfile);
                         userProfile = newUserProfile;

                         if (newUserProfile.bonusCash > 0) {
                             await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`);
                         }

                         if (localReferrerUid && appSettings.referralBonus > 0) {
                             console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${localReferrerUid}`);
                             const referrerRef = ref(db, `users/${localReferrerUid}`);
                             try {
                                 const referrerUpdateResult = await runTransaction(referrerRef, (referrerData) => {
                                     if (referrerData) {
                                         referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus;
                                         referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus;
                                         return recalcProfileBalance(referrerData);
                                     }
                                     return referrerData;
                                 });

                                 if (referrerUpdateResult.committed) {
                                     await recordTransaction(localReferrerUid, 'referral_bonus', appSettings.referralBonus, `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`);
                                     console.log("Referrer bonus awarded successfully.");
                                 } else {
                                     console.error("Referrer bonus transaction aborted.");
                                 }
                             } catch (referrerError) {
                                 console.error("Error awarding referrer bonus:", referrerError);
                             }
                         }
                     }
                     populateUserInfo(user, userProfile); setupRealtimeListeners(user.uid); updateGlobalUI(true);
                     const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                     showSection(targetSection);
                 } catch (error) { console.error("Profile handling error:", error); alert("Error loading profile. Logging out. " + error.message); try { await logoutUser(); } catch (logoutErr) {} }
             } else {
                 console.log("Auth State: Logged Out"); currentUser = null; userProfile = {}; updateGlobalUI(false); 
                 if(elements.appLogo) elements.appLogo.src = 'https://via.placeholder.com/40/FFFFFF/0F172A?text=G'; // Reset logo on logout
                 showSection('login-section');
             }
             showLoader(false);
}

// --- Database Interaction Functions ---
async function loadAppSettings() {
    console.log("Loading App Settings...");
    try {
        const settingsRef = ref(db, 'settings');
        const snapshot = await get(settingsRef);
        if (snapshot.exists()) {
             appSettings = snapshot.val() || {};
             console.log("App Settings Loaded:", appSettings);
             // Do not set app logo from settings if we want user-specific logos
             // if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl;
             if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw;
        } else {
             console.warn("App Settings not found in database!");
             appSettings = {};
        }
    } catch (e) {
        console.error("Settings load failed", e);
         appSettings = {};
    }
}

function loadHomePageData() {
    console.log("Loading Home Page Data...");
     if (!currentUser) {
         if(elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = '';
         if(elements.gamesList) elements.gamesList.innerHTML = '';
         if(elements.myContestsList) {
             removePlaceholders(elements.myContestsList);
             elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view your contests.</p>';
         }
         return; // Don't load anything if not logged in
     }
    loadPromotions();
    loadGames();
    loadMyContests();
}

async function loadPromotions() {
     console.log("Loading Promotions...");
     if (!elements.promotionSlider) return;
     const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
     if (!sliderWrapper) return;
     sliderWrapper.classList.add('placeholder-glow');
     sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`;

     const promoRef = ref(db, 'promotions');
     try {
         const snapshot = await get(promoRef);
         const promotions = snapshot.val() || {};
         const activePromotions = Object.values(promotions).filter(p => p.imageUrl);
         console.log(`Found ${activePromotions.length} active promotions.`);

         removePlaceholders(elements.promotionSlider);
         sliderWrapper.innerHTML = '';

         if (activePromotions.length > 0) {
             elements.promotionSlider.style.display = 'block';
             activePromotions.forEach(promo => {
                 const slide = document.createElement('div');
                 slide.className = 'swiper-slide';
                 slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`;
                 sliderWrapper.appendChild(slide);
             });
             if (swiperInstance) swiperInstance.destroy(true, true);
             swiperInstance = new Swiper(elements.promotionSlider, {
                 loop: activePromotions.length > 1,
                 autoplay: { delay: 3500, disableOnInteraction: false },
                 pagination: { el: '.swiper-pagination', clickable: true },
                 slidesPerView: 1
             });
         } else {
             elements.promotionSlider.style.display = 'none';
         }
     } catch (e) {
         console.error("Promo load failed:", e);
         removePlaceholders(elements.promotionSlider);
         sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>';
         elements.promotionSlider.style.display = 'block';
     }
}

async function loadGames() {
    console.log("Loading Games...");
    if (!elements.gamesList) return;
    elements.gamesList.classList.add('placeholder-glow');
    elements.gamesList.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`;

    const gamesRef = ref(db, 'games');
    try {
        const snapshot = await get(gamesRef);
        const games = snapshot.val() || {};
         const activeGames = Object.entries(games)
                                .filter(([, game]) => game.imageUrl && game.name)
                                .sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));
        console.log(`Found ${activeGames.length} active games.`);

        removePlaceholders(elements.gamesList);
        elements.gamesList.innerHTML = '';

        if (activeGames.length > 0) {
             if (!appSettings.games) appSettings.games = {};
            activeGames.forEach(([gameId, game]) => {
                 appSettings.games[gameId] = { name: game.name };
                const col = document.createElement('div');
                col.className = 'col-6';
                col.innerHTML = `<div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`;
                col.querySelector('.game-card').addEventListener('click', () => {
                    currentTournamentGameId = gameId;
                    loadTournamentsForGame(gameId, game.name);
                });
                elements.gamesList.appendChild(col);
            });
        } else {
            elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>';
        }
    } catch (e) {
        console.error("Games load failed:", e);
        removePlaceholders(elements.gamesList);
        elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>';
    }
}

function loadTournamentsForGame(gameId, gameName) {
     console.log(`Loading tournaments for game: ${gameName} (ID: ${gameId})`);
     if (!elements.tournamentsSection) return;
     currentTournamentGameId = gameId;
     elements.tournamentTabs.forEach(t => t.classList.remove('active'));
     querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active');
     showSection('tournaments-section');
     filterTournaments(gameId, 'upcoming');
}

async function filterTournaments(gameId, status) {
    console.log(`Filtering tournaments for game ${gameId} with status ${status}`);
    if (!elements.tournamentsListContainer) return;
    elements.tournamentsListContainer.innerHTML = '';
    elements.tournamentsListContainer.classList.add('placeholder-glow');
    elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`;
    elements.noTournamentsMessage.style.display = 'none';
    
    try {
        const tQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId));
        const snapshot = await get(tQuery);
        const allTournaments = snapshot.val() || {};
        
        const filteredTournaments = Object.entries(allTournaments)
            .filter(([, tournament]) => {
                if (status === 'completed') {
                    // For the 'Results' tab, show both 'completed' and 'result' statuses
                    return tournament.status === 'completed' || tournament.status === 'result';
                }
                // For other tabs, match the status exactly
                return tournament.status === status;
            })
            .sort(([, tA], [, tB]) => {
                // Sort results by most recent first, and others by soonest first
                if (status === 'completed') {
                    return (tB.startTime || 0) - (tA.startTime || 0); // Descending for completed
                }
                return (tA.startTime || 0) - (tB.startTime || 0); // Ascending for upcoming/ongoing
            });
        
        console.log(`Found ${filteredTournaments.length} tournaments matching criteria.`);

        removePlaceholders(elements.tournamentsListContainer);
        elements.tournamentsListContainer.innerHTML = '';

        if (filteredTournaments.length > 0) {
            filteredTournaments.forEach(([tId, tData]) => {
                const card = createTournamentCardElement(tId, tData);
                elements.tournamentsListContainer.appendChild(card);
            });
        } else {
            elements.noTournamentsMessage.style.display = 'block';
            elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
        }
    } catch (e) {
        console.error(`Tournaments filter failed (${status}):`, e);
        removePlaceholders(elements.tournamentsListContainer);
        let errorMessage = 'Could not load tournaments. An error occurred.';
        if (e.message && (e.message.toLowerCase().includes("index") || e.message.toLowerCase().includes("indexon"))) {
            errorMessage = 'A database configuration error occurred. An index for "gameId" is likely missing in your Firebase rules. This needs to be fixed in the database settings.';
        }
        elements.tournamentsListContainer.innerHTML = `<p class="text-danger text-center mt-4">${errorMessage}</p><p class="text-secondary text-center small">Please check the browser console for more details.</p>`;
        elements.noTournamentsMessage.style.display = 'none';
    }
}

        function createTournamentCardElement(tId, t) {
            const card = document.createElement('div');
            card.className = 'tournament-card';
            card.dataset.tournamentId = tId;

            const eFee = t.entryFee || 0;
            const pkPrize = t.perKillPrize || 0;
            const pPool = t.prizePool || 0;
            const sTime = t.startTime ? new Date(t.startTime) : null;
            const sTimeLoc = sTime ? sTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA';
            
            const regP = t.registeredPlayers || {};
            const regC = Object.values(regP).reduce((count, team) => count + team.teamMembers.length, 0);
            const maxP = t.maxPlayers || 0;
            
            const spotsL = maxP > 0 ? Math.max(0, maxP - regC) : Infinity;
            const isF = maxP > 0 && spotsL <= 0;
            const isJ = currentUser && userProfile?.joinedTournaments?.[tId];
            const canJ = !isJ && !isF && t.status === 'upcoming';
            
            let timerTxt = t.status?.toUpperCase() || 'N/A';
            if (t.status === 'upcoming' && sTime) timerTxt = getTimeRemaining(t.startTime);
            else if (t.status === 'ongoing') timerTxt = 'LIVE';
            else if (t.status === 'completed' || t.status === 'result') timerTxt = 'ENDED';
            
            let spotsTxt = 'Unlimited Spots';
            let progP = 0;
            if (maxP > 0) {
                spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Spots Left (${regC}/${maxP})`;
                progP = Math.min(100, (regC / maxP) * 100);
            }

            let actionsHTML = '';
            
            if ((t.status === 'completed' || t.status === 'result') && t.results) {
                actionsHTML = `
                    <div class="tournament-card-actions" style="grid-template-columns: 1fr;">
                        <button class="btn btn-custom btn-custom-primary btn-sm btn-view-results" data-tournament-id="${tId}"><i class="bi bi-trophy-fill"></i> View Results</button>
                    </div>`;
            } else {
                let actBtn = '';
                let idPassBtn = '';
                let detailsBtn = `<button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}">Details</button>`;
                
                if (isJ) {
                    // --- Gemini: 'Joined' বাটনের পরিবর্তে 'View Team' বাটন যুক্ত করা হয়েছে ---
                    actBtn = `<button class="btn btn-custom btn-sm btn-custom-primary btn-view-team" data-tournament-id="${tId}"><i class="bi bi-people-fill"></i> View Team</button>`;
                    if (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && sTime && Date.now() > sTime.getTime() - 900000)) {
                        idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                    }
                } else if (canJ) {
                    actBtn = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${eFee}">₹${eFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
                } else {
                    let disR = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed');
                    if (t.status === 'completed' || t.status === 'result') disR = 'ENDED';
                    actBtn = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disR || 'N/A'}</button>`;
                }

                actionsHTML = `<div class="tournament-card-actions">${detailsBtn}${actBtn}</div>${idPassBtn}`;
            }

            card.innerHTML = `
                <div class="tournament-card-header">
                    <div class="tournament-card-tags">
                        ${t.mode ? `<span>${t.mode}</span>` : ''}
                        ${t.map ? `<span>${t.map}</span>` : ''}
                        ${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}
                    </div>
                    <div class="tournament-card-timer">${timerTxt}</div>
                </div>
                <h3 class="tournament-card-title">${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} ${t.name || 'Tournament'}</h3>
                <p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p>
                <div class="tournament-card-info">
                    <div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ₹${pPool}</strong></div>
                    <div class="info-item"><span>Per Kill</span><strong>₹${pkPrize}</strong></div>
                    <div class="info-item"><span>Entry Fee/Player</span><strong class="${eFee > 0 ? 'text-info' : ''}">${eFee > 0 ? `₹${eFee}` : 'Free'}</strong></div>
                </div>
                <div class="tournament-card-spots">
                    ${spotsTxt}
                    ${maxP > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}
                </div>
                ${actionsHTML}`;

            const jBtn = card.querySelector('.btn-join'); if (jBtn) jBtn.addEventListener('click', handleJoinTournamentClick);
            const dBtn = card.querySelector('.btn-details'); if (dBtn) dBtn.addEventListener('click', handleMatchDetailsClick);
            const ipBtn = card.querySelector('.btn-idpass'); if (ipBtn) ipBtn.addEventListener('click', handleIdPasswordClick);
            const vrBtn = card.querySelector('.btn-view-results'); if (vrBtn) vrBtn.addEventListener('click', handleViewResultsClick);

            return card;
        }

async function loadMyContests() {
     console.log("Loading My Contests for homepage...");
     if (!currentUser || !elements.myContestsList) { if(elements.myContestsList) removePlaceholders(elements.myContestsList); if(elements.myContestsList) elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; }
     
     const joinedTournaments = userProfile.joinedTournaments || {};
     const joinedIds = Object.keys(joinedTournaments);

     elements.myContestsList.classList.add('placeholder-glow');
     elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`;
     if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none';
     if (joinedIds.length === 0) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; console.log("No joined contests found for user."); return; }
     
     try {
         const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
         const snapshots = await Promise.all(contestPromises);
         removePlaceholders(elements.myContestsList);
         elements.myContestsList.innerHTML = '';
         const contestCards = [];
         snapshots.forEach((snapshot, index) => {
             const tId = joinedIds[index];
             if (snapshot.exists()) {
                 const t = snapshot.val();
                 if (t.status === 'upcoming' || t.status === 'ongoing') {
                     contestCards.push({ startTime: t.startTime || 0, card: createTournamentCardElement(tId, t) });
                 }
             }
         });
         contestCards.sort((a, b) => a.startTime - b.startTime);
         if (contestCards.length > 0) {
             contestCards.forEach(item => elements.myContestsList.appendChild(item.card));
         } else if (elements.noContestsMessage) {
             elements.noContestsMessage.style.display = 'block';
             elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests.";
         }
     } catch (e) { console.error("My contests load failed:", e); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>'; }
}

async function loadDedicatedMyContests() {
    console.log("Loading all My Contests for dedicated page...");
    if (!currentUser) return;
    const listEl = elements.myContestsSectionList;
    const messageEl = elements.noMyContestsMessage;

    listEl.classList.add('placeholder-glow');
    listEl.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`;
    messageEl.style.display = 'none';

    const joinedTournaments = userProfile.joinedTournaments || {};
    const joinedIds = Object.keys(joinedTournaments);

    if (joinedIds.length === 0) {
        removePlaceholders(listEl);
        listEl.innerHTML = '';
        messageEl.style.display = 'block';
        return;
    }

    try {
        const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
        const snapshots = await Promise.all(contestPromises);
        removePlaceholders(listEl);
        listEl.innerHTML = '';

        const contestsByStatus = { upcoming: [], ongoing: [], completed: [], result: [] };
        
        snapshots.forEach((snapshot, index) => {
            const tId = joinedIds[index];
            if (snapshot.exists()) {
                const t = snapshot.val();
                if (contestsByStatus[t.status]) {
                    contestsByStatus[t.status].push({ ...t, tId });
                }
            }
        });
        
        contestsByStatus.upcoming.sort((a, b) => (a.startTime || 0) - (b.startTime || 0));
        contestsByStatus.ongoing.sort((a, b) => (a.startTime || 0) - (b.startTime || 0));
        const finishedContests = [...contestsByStatus.completed, ...contestsByStatus.result];
        finishedContests.sort((a, b) => (b.startTime || 0) - (a.startTime || 0));

        const allContests = [...contestsByStatus.ongoing, ...contestsByStatus.upcoming, ...finishedContests];

        if (allContests.length > 0) {
            allContests.forEach(t => {
                const card = createTournamentCardElement(t.tId, t);
                listEl.appendChild(card);
            });
        } else {
            messageEl.style.display = 'block';
        }

    } catch (e) {
        console.error("Dedicated My Contests load failed:", e);
        removePlaceholders(listEl);
        listEl.innerHTML = '<p class="text-danger tc">Could not load your contests.</p>';
    }
}
        /**
         * --- Bengali Comment for Developer ---
         * নতুন লিডারবোর্ড ফাংশন। এটি এখন সময়কালের (period) উপর ভিত্তি করে ডেটা লোড করবে।
         * 'all_time' বিকল্পটি পুরানো পদ্ধতির মতো কাজ করবে, বাকিগুলো নতুন `leaderboard_logs` থেকে ডেটা আনবে।
         */
        async function loadLeaderboardData(period = 'weekly') {
            console.log(`Loading Leaderboard Data for period: ${period}`);
            const listEl = elements.leaderboardList;
            const messageEl = elements.noLeaderboardMessage;

            listEl.innerHTML = ''; // Clear previous results
            listEl.classList.add('placeholder-glow');
            listEl.innerHTML = `<div class="leaderboard-item"><span class="placeholder col-1 me-3" style="height: 24px;"></span> <span class="placeholder rounded-circle" style="width: 45px; height: 45px;"></span> <div class="leaderboard-info ms-3 flex-grow-1"><span class="placeholder col-5 d-block" style="height: 20px;"></span><span class="placeholder col-3 d-block mt-1" style="height: 16px;"></span></div></div>`.repeat(5);
            messageEl.style.display = 'none';

            try {
                let users = [];
                // 'All Time' লিডারবোর্ড আগের মতোই কাজ করবে
                if (period === 'all_time') {
                    const usersRef = ref(db, 'users');
                    const leaderboardQuery = query(usersRef, orderByChild('totalEarnings'), limitToLast(50));
                    const snapshot = await get(leaderboardQuery);
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            if (childSnapshot.val().totalEarnings > 0) {
                                users.push(childSnapshot.val());
                            }
                        });
                        users.reverse(); // Sort descending
                    }
                } else {
                    // সাপ্তাহিক এবং মাসিক লিডারবোর্ডের জন্য নতুন লজিক
                    const now = new Date();
                    let startTime;

                    if (period === 'weekly') {
                        const dayOfWeek = now.getDay(); // 0 (Sun) to 6 (Sat)
                        const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday
                        startTime = new Date(now.setDate(diff));
                        startTime.setHours(0, 0, 0, 0); // Start of the day
                    } else { // monthly
                        startTime = new Date(now.getFullYear(), now.getMonth(), 1);
                        startTime.setHours(0, 0, 0, 0);
                    }
                    
                    const logsRef = ref(db, 'leaderboard_logs');
                    const logsQuery = query(logsRef, orderByChild('timestamp'), startAt(startTime.getTime()));
                    
                    const snapshot = await get(logsQuery);
                    
                    if (snapshot.exists()) {
                        const userWinnings = {}; // userId -> { total, displayName, photoURL }
                        snapshot.forEach(child => {
                            const log = child.val();
                            if (!userWinnings[log.userId]) {
                                userWinnings[log.userId] = { 
                                    total: 0, 
                                    displayName: log.displayName,
                                    photoURL: log.photoURL
                                };
                            }
                            userWinnings[log.userId].total += log.amount;
                        });

                        // লিডারবোর্ডের জন্য ইউজারদের তালিকা তৈরি ও সর্ট করা
                        users = Object.entries(userWinnings).map(([userId, data]) => ({
                            uid: userId,
                            displayName: data.displayName,
                            photoURL: data.photoURL,
                            totalEarnings: data.total // আমরা এই ফিল্ডটি ব্যবহার করব
                        }));
                        
                        users.sort((a, b) => b.totalEarnings - a.totalEarnings);
                        users = users.slice(0, 50); // Top 50
                    }
                }
                
                removePlaceholders(listEl);
                listEl.innerHTML = '';

                if (users.length > 0) {
                    users.forEach((user, index) => {
                        const rank = index + 1;
                        const name = user.displayName || 'Anonymous';
                        const score = user.totalEarnings || 0;
                        const avatar = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1E293B&color=E2E8F0&bold=true`;
                        
                        let rankClass = (rank === 1) ? 'rank-1' : (rank === 2) ? 'rank-2' : (rank === 3) ? 'rank-3' : '';

                        const item = document.createElement('li');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `
                            <span class="leaderboard-rank ${rankClass}">${rank}</span>
                            <img src="${avatar}" alt="${name}" class="leaderboard-avatar">
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${name}</div>
                                <div class="leaderboard-score">Winnings: <strong>₹${score.toFixed(2)}</strong></div>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });
                } else {
                    messageEl.style.display = 'block';
                }

            } catch (e) {
                console.error(`Leaderboard load failed for period ${period}:`, e);
                removePlaceholders(listEl);
                listEl.innerHTML = '<p class="text-danger text-center">Could not load leaderboard. Check DB rules/index.</p>';
                messageEl.style.display = 'none';
            }
        }


function loadWalletData() {
     console.log("Loading Wallet Data...");
     if (!currentUser) return;
     loadRecentTransactions();
}

function loadProfileData() {
    console.log("Loading Profile Data...");
    if (!currentUser) return;
    
    // The main logic is handled by the realtime listener calling populateUserInfo.
    // This function ensures that if the data is already in state, it's displayed when navigating to the profile section.
    if (userProfile && userProfile.uid) {
        populateUserInfo(currentUser, userProfile);
    }
}

async function recordTransaction(userId, type, amount, description, details = {}) {
    if (!userId) return;
    const transactionRef = ref(db, `transactions/${userId}`);
    const newTransaction = { type, amount, description, timestamp: serverTimestamp(), ...details };
    try {
        await push(transactionRef, newTransaction);
        console.log(`Transaction recorded: ${type}, Amount: ${amount}`);
    } catch (e) {
        console.error("Transaction record failed:", e);
    }
}

async function loadRecentTransactions() {
     console.log("Loading Recent Transactions...");
     if (!currentUser || !elements.recentTransactionsList) return; const limit = 5;
     elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow');
     for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>`;
     if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; }
     try {
         const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit));
         const s = await get(transRef);
         const transactions = s.val() || {};
         const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
         console.log(`Found ${sortedT.length} recent transactions.`);

         removePlaceholders(elements.recentTransactionsList);
         elements.recentTransactionsList.innerHTML = '';

         if (sortedT.length > 0) {
             if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none';
             sortedT.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}₹${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'; item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type || 'Txn'}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.recentTransactionsList.appendChild(item); });
         } else if (elements.noTransactionsMessage) {
             elements.noTransactionsMessage.style.display = 'block';
             elements.noTransactionsMessage.textContent = 'No recent transactions.';
         }
     } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; }
}

// New function for all transactions
async function loadAllTransactions() {
    console.log("Loading All Transactions...");
    if (!currentUser) return;
    
    const listEl = elements.allTransactionsList;
    const messageEl = elements.noAllTransactionsMessage;

    listEl.innerHTML = '';
    listEl.classList.add('placeholder-glow');
    for (let i = 0; i < 5; i++) {
        listEl.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5"></span><span class="placeholder col-3"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6"></span></div></div>`;
    }
    messageEl.style.display = 'none';

    try {
        const transRef = ref(db, `transactions/${currentUser.uid}`);
        const snapshot = await get(transRef);
        
        removePlaceholders(listEl);
        listEl.innerHTML = '';

        if (snapshot.exists()) {
            const transactions = snapshot.val();
            const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            if (sortedT.length > 0) {
                sortedT.forEach(t => {
                    const item = document.createElement('div');
                    item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center';
                    const isCredit = t.amount > 0;
                    const amountText = `${isCredit ? '+' : ''}₹${Math.abs(t.amount || 0).toFixed(2)}`;
                    const timeText = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                    
                    item.innerHTML = `
                        <div>
                            <div class="small fw-bold">${t.description || t.type || 'Transaction'}</div>
                            <div class="small text-secondary">${timeText}</div>
                        </div>
                        <div class="fw-bold ${isCredit ? 'text-success' : 'text-danger'}">${amountText}</div>
                    `;
                    listEl.appendChild(item);
                });
            } else {
                messageEl.style.display = 'block';
            }
        } else {
            messageEl.style.display = 'block';
        }
    } catch (e) {
        console.error("All Transactions load failed:", e);
        removePlaceholders(listEl);
        listEl.innerHTML = '<p class="text-danger text-center">Could not load transaction history.</p>';
    }
}


async function handleJoinTournamentClick(event) {
    if (!currentUser) {
        alert("Please login to join.");
        showSection('login-section');
        return;
    }
    const btn = event.currentTarget;
    const tId = btn.dataset.tournamentId;
    if (!tId) return;

    showLoader(true);

    try {
        const tRef = ref(db, `tournaments/${tId}`);
        const snapshot = await get(tRef);
        if (!snapshot.exists()) {
            throw new Error("Tournament not found.");
        }
        const tData = snapshot.val();
        
        const tags = (Array.isArray(tData.tags) ? tData.tags : Object.values(tData.tags || {})).map(tag => String(tag).toLowerCase());
        let teamSize = 1; 
        let mode = 'Solo';
        if (tags.includes('squad')) {
            teamSize = 4;
            mode = 'Squad';
        } else if (tags.includes('duo')) {
            teamSize = 2;
            mode = 'Duo';
        }

        setupSeatSelectionModal(tId, tData, teamSize, mode, false);

    } catch (error) {
        console.error("Error preparing for join:", error);
        alert(`Error: ${error.message}`);
        showLoader(false);
    }
}

function setupSeatSelectionModal(tId, tData, teamSize, mode, viewOnly = false) {
    // --- Gemini: মোডালটি 'view-only' মোডে আছে কিনা তা সেট করা হচ্ছে ---
    const modalEl = elements.seatSelectionModalInstance._element;
    if (viewOnly) {
        modalEl.classList.add('view-only');
    } else {
        modalEl.classList.remove('view-only');
    }

    elements.teamMemberSelection.innerHTML = '';
    elements.seatSelectionGrid.innerHTML = '';
    clearStatusMessage(elements.seatSelectionStatusMessage);

    // --- Gemini: 'view-only' মোড এবং জয়েনিং মোডের জন্য UI পরিবর্তন ---
    if (viewOnly) {
        elements.seatSelectionModalLabel.textContent = `Team & Seat Map`;
        elements.seatSelectionHelperText.textContent = `You are viewing the current seat arrangement. Your seats are highlighted in blue.`;
    } else {
        elements.seatSelectionModalLabel.textContent = `Join as a ${mode} Team`;

        let playerCountHtml = `
            <div class="mb-3">
                <label for="playerCountSelect" class="form-label">How many players are you joining with?</label>
                <select class="form-select" id="playerCountSelect" style="background-color: var(--primary-bg); border-color: var(--border-color); color: var(--text-primary);">
        `;
        for (let i = 1; i <= teamSize; i++) {
            playerCountHtml += `<option value="${i}">${i} Player${i > 1 ? 's' : ''}</option>`;
        }
        playerCountHtml += `</select></div><div id="teamMemberInputsEl"></div>`;
        elements.teamMemberSelection.innerHTML = playerCountHtml;

        const playerCountSelect = getElement('playerCountSelect');
        const teamMemberInputsContainer = getElement('teamMemberInputsEl');

        function generateIgnInputs(count) {
            teamMemberInputsContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control mb-2';
                input.placeholder = `Player ${i + 1} In-Game Name`;
                if (i === 0 && userProfile.lastUsedIgn) {
                    input.value = userProfile.lastUsedIgn;
                }
                teamMemberInputsContainer.appendChild(input);
            }
            updateHelperText();
        }

        playerCountSelect.addEventListener('change', () => {
            generateIgnInputs(parseInt(playerCountSelect.value, 10));
            elements.seatSelectionGrid.querySelectorAll('.selected').forEach(s => s.classList.remove('selected'));
        });

        generateIgnInputs(1);

        function updateHelperText() {
            const numPlayers = parseInt(playerCountSelect.value, 10);
            elements.seatSelectionHelperText.textContent = `Please select ${numPlayers} available seat(s) from the same team group.`;
        }
    }
    
    // --- Gemini: রেজিস্ট্রেশন করা খেলোয়াড় এবং বর্তমান ব্যবহারকারীর সিট নম্বর খুঁজে বের করা হচ্ছে ---
    const registeredPlayers = tData.registeredPlayers || {};
    const myRegistration = registeredPlayers[currentUser.uid];
    const mySeatNumbers = myRegistration ? myRegistration.teamMembers.map(m => m.seatNumber) : [];
    
    let allTakenSeats = [];
    Object.values(registeredPlayers).forEach(registration => {
        if (registration.teamMembers && Array.isArray(registration.teamMembers)) {
            allTakenSeats.push(...registration.teamMembers);
        }
    });

    // Seat Grid তৈরি করা হচ্ছে
    const maxSeats = tData.maxPlayers || 0;
    const effectiveTeamSize = teamSize > 0 ? teamSize : 1; // Prevent infinite loop if teamSize is 0

    for (let i = 0; i < maxSeats; i += effectiveTeamSize) {
        const teamBox = document.createElement('div');
        teamBox.className = 'team-box';
        teamBox.dataset.teamId = i / effectiveTeamSize;

        let seatsInTeam = [];
        let takenCount = 0;

        for (let j = 0; j < effectiveTeamSize; j++) {
            const seatNumber = i + j + 1;
            if (seatNumber > maxSeats) continue; 
            
            const seat = document.createElement('div');
            seat.className = 'seat-box';
            seat.dataset.seatNumber = seatNumber;

            const takenInfo = allTakenSeats.find(s => s.seatNumber === seatNumber);
            if (takenInfo) {
                seat.classList.add('taken');
                // --- Gemini: এই সিটটি বর্তমান ব্যবহারকারীর কিনা তা পরীক্ষা করে হাইলাইট করা হচ্ছে ---
                if (mySeatNumbers.includes(seatNumber)) {
                    seat.classList.add('my-seat');
                }
                seat.innerHTML = `${seatNumber}<span class="player-ign">${takenInfo.ign}</span>`;
                takenCount++;
            } else {
                seat.textContent = seatNumber;
                // --- Gemini: শুধুমাত্র জয়েন করার মোডে ক্লিক ইভেন্ট যোগ করা হচ্ছে ---
                if (!viewOnly) {
                    seat.addEventListener('click', handleSeatClick);
                }
            }
            seatsInTeam.push(seat);
        }

        if (takenCount === effectiveTeamSize) {
            teamBox.classList.add('full');
        } else if (takenCount > 0) {
            teamBox.classList.add('partial');
        }
        
        seatsInTeam.forEach(seat => teamBox.appendChild(seat));
        elements.seatSelectionGrid.appendChild(teamBox);
    }
    
    function handleSeatClick(event) {
        const clickedSeat = event.currentTarget;
        const parentTeamBox = clickedSeat.closest('.team-box');
        const playerCountSelect = getElement('playerCountSelect');
        const numToSelect = parseInt(playerCountSelect.value, 10);
        
        elements.seatSelectionGrid.querySelectorAll('.seat-box.selected').forEach(s => {
            if (s.closest('.team-box') !== parentTeamBox) {
                s.classList.remove('selected');
            }
        });
        
        const isSelected = clickedSeat.classList.contains('selected');
        const selectedInThisTeam = parentTeamBox.querySelectorAll('.selected').length;

        if (isSelected) {
            clickedSeat.classList.remove('selected');
        } else {
            const availableSeatsInTeam = parentTeamBox.querySelectorAll('.seat-box:not(.taken)').length;
            if (numToSelect > availableSeatsInTeam) {
                showStatusMessage(elements.seatSelectionStatusMessage, `Not enough free seats in this team for ${numToSelect} player(s).`, 'warning');
                return;
            }

            if (selectedInThisTeam < numToSelect) {
                clickedSeat.classList.add('selected');
            } else {
                showStatusMessage(elements.seatSelectionStatusMessage, `You can only select ${numToSelect} seat(s). Unselect one first.`, 'warning');
            }
        }
    }

    // Confirmation Button Logic
    if (!viewOnly) {
        const old_btn = elements.confirmSeatSelectionBtn;
        const new_btn = old_btn.cloneNode(true);
        old_btn.parentNode.replaceChild(new_btn, old_btn);
        elements.confirmSeatSelectionBtn = new_btn;
        
        elements.confirmSeatSelectionBtn.onclick = () => {
            const playerCountSelect = getElement('playerCountSelect');
            const numToSelect = parseInt(playerCountSelect.value, 10);
            const teamMemberInputsContainer = getElement('teamMemberInputsEl');
            const ignInputs = teamMemberInputsContainer.querySelectorAll('input');
            const teamMembers = [];
            for (const input of ignInputs) {
                if (!input.value.trim()) {
                    showStatusMessage(elements.seatSelectionStatusMessage, 'Please enter all player names.', 'danger');
                    return;
                }
                teamMembers.push({ ign: input.value.trim() });
            }

            const selectedSeats = elements.seatSelectionGrid.querySelectorAll('.selected');
            if (selectedSeats.length !== numToSelect) {
                showStatusMessage(elements.seatSelectionStatusMessage, `Please select exactly ${numToSelect} seats.`, 'danger');
                return;
            }

            selectedSeats.forEach((seat, index) => {
                teamMembers[index].seatNumber = parseInt(seat.dataset.seatNumber, 10);
            });

            elements.seatSelectionModalInstance.hide();
            const totalEntryFee = (tData.entryFee || 0) * numToSelect;
            processTournamentJoin(tId, totalEntryFee, teamMembers);
        };
    }

    showLoader(false);
    elements.seatSelectionModalInstance.show();
}

async function processTournamentJoin(tId, fee, teamMembers) {
    showLoader(true);
    const uRef = ref(db, `users/${currentUser.uid}`);
    const tRef = ref(db, `tournaments/${tId}`);
    let balanceDeducted = false;

    try {
        const userTxResult = await runTransaction(uRef, (profileData) => {
            if (profileData) {
                const currentBalance = (profileData.winningCash || 0) + (profileData.bonusCash || 0);
                if (currentBalance < fee) {
                    throw new Error("INSUFFICIENT_FUNDS");
                }
                if (profileData.joinedTournaments && profileData.joinedTournaments[tId]) {
                    throw new Error("ALREADY_JOINED");
                }

                let feeToPay = fee;
                let winningDeducted = Math.min(profileData.winningCash || 0, feeToPay);
                profileData.winningCash -= winningDeducted;
                feeToPay -= winningDeducted;
                
                if(feeToPay > 0) {
                    let bonusDeducted = Math.min(profileData.bonusCash || 0, feeToPay);
                    profileData.bonusCash -= bonusDeducted;
                    feeToPay -= bonusDeducted;
                }

                if (feeToPay > 0.01) { 
                    throw new Error("INSUFFICIENT_FUNDS_DURING_TX");
                }

                profileData.lastUsedIgn = teamMembers[0].ign;
                if (!profileData.joinedTournaments) profileData.joinedTournaments = {};
                profileData.joinedTournaments[tId] = { joinedAt: serverTimestamp(), players: teamMembers.length }; 
                
                return recalcProfileBalance(profileData);
            }
            return profileData;
        });

        if (!userTxResult.committed) {
            throw new Error("Could not process your entry due to a conflict. Please try again.");
        }
        balanceDeducted = true;
        userProfile = userTxResult.snapshot.val();
        populateUserInfo(currentUser, userProfile);
        console.log("Balance transaction successful.");

        const tournamentTxResult = await runTransaction(tRef, (tData) => {
            if (tData) {
                const registered = tData.registeredPlayers || {};
                const playerSeats = teamMembers.map(m => m.seatNumber);

                // Check if any of the seats are already taken in the database
                const allTakenSeatNumbers = Object.values(registered).flatMap(team => team.teamMembers.map(m => m.seatNumber));
                const isAnySeatTaken = playerSeats.some(seat => allTakenSeatNumbers.includes(seat));
                if (isAnySeatTaken) throw new Error("SEAT_TAKEN");

                // Check for tournament capacity
                 const currentPlayersCount = allTakenSeatNumbers.length;
                 if (tData.maxPlayers > 0 && (currentPlayersCount + teamMembers.length) > tData.maxPlayers) {
                     throw new Error("TOURNAMENT_FULL");
                 }
                
                // Save the joining user's registration
                registered[currentUser.uid] = {
                    teamMembers: teamMembers,
                    joinedAt: serverTimestamp(),
                    displayName: userProfile.displayName || currentUser.email,
                };
                tData.registeredPlayers = registered;
            }
            return tData;
        });

        if (!tournamentTxResult.committed) {
             throw new Error("One of the selected seats was just taken. Your entry fee has been refunded.");
        }
        
        const finalTournamentData = tournamentTxResult.snapshot.val();
        await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined: ${finalTournamentData.name || 'Tournament'}`, {
            tournamentId: tId, team: teamMembers 
        });

        const teamNames = teamMembers.map(m => m.ign).join(', ');
        alert(`Joined successfully!\nPlayers: ${teamNames}\nSeats: ${teamMembers.map(m=>m.seatNumber).join(', ')}\n₹${fee.toFixed(2)} deducted.`);
        
        updateUIAfterJoin(tId, finalTournamentData);

    } catch (error) {
        console.error("Join processing failed:", error);
        let errorMessage = error.message || "An unknown error occurred.";
        if (errorMessage === "INSUFFICIENT_FUNDS") errorMessage = "Insufficient balance.";
        else if (errorMessage === "ALREADY_JOINED") errorMessage = "You have already registered for this tournament.";
        else if (errorMessage === "SEAT_TAKEN") errorMessage = "Sorry, one of the seats you selected was just taken. Your fee has been refunded.";
        else if (errorMessage === "TOURNAMENT_FULL") errorMessage = "Sorry, the tournament is now full. Your fee has been refunded.";
        alert(`Join Failed: ${errorMessage}`);
        
        if (balanceDeducted) {
            console.warn("CRITICAL: Balance deducted but tournament join failed. Initiating refund.");
            showLoader(true);
            try {
                const refundTx = await runTransaction(uRef, (profileData) => {
                    if (profileData) {
                        profileData.winningCash = (profileData.winningCash || 0) + fee;
                        if (profileData.joinedTournaments && profileData.joinedTournaments[tId]) {
                            delete profileData.joinedTournaments[tId];
                        }
                        return recalcProfileBalance(profileData);
                    }
                    return profileData;
                });
                if (refundTx.committed) {
                    await recordTransaction(currentUser.uid, 'join_failed_refund', fee, `Refund Failed Join: ${tId}`);
                    userProfile = refundTx.snapshot.val();
                    populateUserInfo(currentUser, userProfile);
                    console.log("Refund successful.");
                } else { throw new Error("Refund transaction failed to commit."); }
            } catch (refundError) {
                console.error("!!! CRITICAL FAILURE: FAILED TO REFUND BALANCE !!!", refundError);
                alert(`CRITICAL ERROR: We failed to join the tournament AND failed to refund your balance (₹${fee.toFixed(2)}). Please contact support immediately with Tournament ID: ${tId}`);
            } finally {
               showLoader(false);
            }
        }
    } finally {
        showLoader(false);
    }
}


function updateUIAfterJoin(tId, tData) {
    const cardEl = document.querySelector(`.tournament-card[data-tournament-id="${tId}"]`);
    if (cardEl) {
        cardEl.parentNode.replaceChild(createTournamentCardElement(tId, tData), cardEl);
    } else {
        if (currentSectionId === 'tournaments-section' && currentTournamentGameId) {
            const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
            filterTournaments(currentTournamentGameId, activeTab);
        }
    }
    if (currentSectionId === 'home-section') {
        loadMyContests();
    }
    if (currentSectionId === 'my-contests-section') {
        loadDedicatedMyContests();
    }
}


// --- Modal Handlers & Other Functions ---
async function handleEditProfileName() {
    if (!currentUser) return;
    const currentName = userProfile.displayName || '';
    const newName = prompt("Enter your new display name:", currentName);

    if (newName && newName.trim() !== '' && newName !== currentName) {
        showLoader(true);
        try {
            const userRef = ref(db, `users/${currentUser.uid}`);
            await update(userRef, { displayName: newName.trim() });
            alert("Name updated successfully!");
        } catch (error) {
            console.error("Error updating name:", error);
            alert("Failed to update name. Please try again.");
        } finally {
            showLoader(false);
        }
    }
}

 function handleWithdrawClick() {
     if (!currentUser || !elements.withdrawModalInstance) return;
     const wc = userProfile.winningCash || 0;
     const minW = appSettings?.minWithdraw || 50;
     elements.minWithdrawAmount.textContent = minW;
     elements.withdrawModalBalance.textContent = `₹${wc.toFixed(2)}`;
     elements.withdrawAmountInput.value = '';
     elements.withdrawAmountInput.min = minW;
     elements.withdrawMethodInput.value = userProfile.upiId || '';
     clearStatusMessage(elements.withdrawStatusMessage);
     elements.withdrawModalInstance.show();
 }

 async function submitWithdrawRequestHandler() {
     if (!currentUser || !elements.withdrawModalInstance) return;
     const amt = parseFloat(elements.withdrawAmountInput.value);
     const mtd = elements.withdrawMethodInput.value.trim();
     const wc = userProfile.winningCash || 0;
     const minW = appSettings?.minWithdraw || 50;
     clearStatusMessage(elements.withdrawStatusMessage);
     if (isNaN(amt) || amt <= 0) { showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning'); return; }
     if (amt < minW) { showStatusMessage(elements.withdrawStatusMessage, `Min withdraw ₹${minW}.`, 'warning'); return; }
     if (amt > wc) { showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning'); return; }
     if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; }
     elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
     let transactionCommitted = false;
     try {
         const uRef = ref(db, `users/${currentUser.uid}`);
         const txResult = await runTransaction(uRef, (prof) => {
             if (prof) {
                 if ((prof.winningCash || 0) >= amt) {
                     prof.winningCash = (prof.winningCash || 0) - amt;
                     return recalcProfileBalance(prof);
                 } else { throw new Error("Insufficient winning balance (Tx)."); }
             } else { throw new Error("Profile missing (Tx)."); }
         });

          if (!txResult.committed) {
                throw new Error("Failed to update balance. Please try again.");
          }
          transactionCommitted = true;
          userProfile = txResult.snapshot.val();
          populateUserInfo(currentUser, userProfile);
         console.log("Winning cash deducted successfully.");

         const wrRef = ref(db, 'withdrawals');
         const newReq = {
             userId: currentUser.uid,
             userName: userProfile.displayName || currentUser.email,
             amount: amt,
             methodDetails: {
                 methodName: mtd.includes('@') ? 'UPI' : 'Bank/Other',
                 accountInfo: mtd
             },
             status: 'pending',
             requestTimestamp: serverTimestamp(),
             userEmail: currentUser.email || 'N/A'
         };
         const newWithdrawalRef = await push(wrRef, newReq);
         console.log("Withdrawal request created:", newWithdrawalRef.key);

         await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newWithdrawalRef.key });

         showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false);
         setTimeout(() => { if (elements.withdrawModalInstance) elements.withdrawModalInstance.hide(); }, 2500);

     } catch (e) {
         console.error("Withdraw error:", e);
         showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger');
         if (transactionCommitted) {
             console.warn("Attempting to refund winning cash due to withdrawal request failure...");
             const uRef = ref(db, `users/${currentUser.uid}`);
             try {
                 const refundTx = await runTransaction(uRef, (prof) => {
                     if (prof) {
                         prof.winningCash = (prof.winningCash || 0) + amt;
                         return recalcProfileBalance(prof);
                     }
                     return prof;
                 });
                 if(refundTx.committed) {
                    await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal Request`);
                    userProfile = refundTx.snapshot.val();
                    populateUserInfo(currentUser, userProfile);
                    console.log("Refund successful.");
                 }
                 showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger');
             } catch (refundError) {
                 console.error("CRITICAL: FAILED TO REFUND WINNING CASH!", refundError);
                 showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. CRITICAL: Failed to refund amount! Contact support.`, 'danger', false);
             }
         }
     } finally {
         elements.submitWithdrawRequestBtn.disabled = false;
         elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request';
     }
 }

        // --- Gemini: 'Send to Friend' Modal and Logic ---

        function handleSendToFriendClick() {
            if (!currentUser || !elements.sendToFriendModalInstance) return;
            const wc = userProfile.winningCash || 0;
            elements.sendModalBalance.textContent = `₹${wc.toFixed(2)}`;
            elements.sendFriendCodeInput.value = '';
            elements.sendAmountInput.value = '';
            clearStatusMessage(elements.sendToFriendStatusMessage);
            elements.sendToFriendModalInstance.show();
        }

        async function confirmSendToFriendHandler() {
            const friendCode = elements.sendFriendCodeInput.value.trim();
            const amount = parseFloat(elements.sendAmountInput.value);
            const statusEl = elements.sendToFriendStatusMessage;
            
            // --- Validation ---
            if (!friendCode || isNaN(amount) || amount <= 0) {
                showStatusMessage(statusEl, 'Please enter a valid code and amount.', 'warning');
                return;
            }
            if (amount > (userProfile.winningCash || 0)) {
                showStatusMessage(statusEl, 'Insufficient winning cash to send.', 'danger');
                return;
            }
            if (friendCode.toLowerCase() === (userProfile.referralCode || '').toLowerCase()) {
                showStatusMessage(statusEl, 'You cannot send money to yourself.', 'warning');
                return;
            }

            elements.confirmSendToFriendBtn.disabled = true;
            elements.confirmSendToFriendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
            clearStatusMessage(statusEl);

            try {
                // --- Find Recipient ---
                const usersRef = ref(db, 'users');
                const q = query(usersRef, orderByChild('referralCode'), equalTo(friendCode));
                const snapshot = await get(q);

                if (!snapshot.exists()) {
                    throw new Error("Recipient with this referral code not found.");
                }
                
                const recipientData = snapshot.val();
                const recipientId = Object.keys(recipientData)[0];
                const recipientProfile = recipientData[recipientId];
                
                if (!recipientId) {
                    throw new Error("Could not identify the recipient user.");
                }

                // --- Perform Transaction ---
                const senderRef = ref(db, `users/${currentUser.uid}`);
                
                // Run a single transaction to update both sender and receiver atomically
                const senderTxResult = await runTransaction(senderRef, (senderProfile) => {
                    if (senderProfile) {
                        // Double-check sender's balance inside the transaction
                        if ((senderProfile.winningCash || 0) < amount) {
                            // Abort the transaction by returning undefined
                            return; 
                        }
                        senderProfile.winningCash -= amount;
                        return recalcProfileBalance(senderProfile);
                    }
                    return senderProfile;
                });

                if (!senderTxResult.committed) {
                    throw new Error("Insufficient winning cash or conflict updating your balance. Please try again.");
                }

                // If sender's balance is successfully debited, credit the receiver
                const recipientRef = ref(db, `users/${recipientId}`);
                await runTransaction(recipientRef, (newRecipientProfile) => {
                    if (newRecipientProfile) {
                        // ===================================================
                        // ===== এখানে পরিবর্তন করা হয়েছে (THIS IS THE CHANGE) =====
                        // ===================================================
                        // প্রাপকের Bonus Cash-এ টাকা যোগ হবে
                        newRecipientProfile.bonusCash = (newRecipientProfile.bonusCash || 0) + amount;
                        return recalcProfileBalance(newRecipientProfile);
                    }
                    return newRecipientProfile;
                });


                // --- Record Transactions for both users ---
                await recordTransaction(currentUser.uid, 'p2p_sent', -amount, `Sent to ${recipientProfile.displayName || 'friend'}`);
                await recordTransaction(recipientId, 'p2p_received', amount, `Received from ${userProfile.displayName || 'friend'}`);

                showStatusMessage(statusEl, 'Amount sent successfully!', 'success', false);
                setTimeout(() => {
                    if(elements.sendToFriendModalInstance) elements.sendToFriendModalInstance.hide();
                }, 2500);

            } catch (error) {
                console.error("Send to Friend Error:", error);
                showStatusMessage(statusEl, `Error: ${error.message}`, 'danger');
            } finally {
                elements.confirmSendToFriendBtn.disabled = false;
                elements.confirmSendToFriendBtn.innerHTML = 'Confirm & Send';
            }
        }

        // --- Gemini: নতুন 'View Team' বাটন হ্যান্ডেল করার জন্য ফাংশন ---
        async function handleViewTeamClick(event) {
            if (!currentUser) return;
            const btn = event.target.closest('.btn-view-team');
            const tId = btn.dataset.tournamentId;
            if (!tId) return;

            showLoader(true);
            try {
                const tRef = ref(db, `tournaments/${tId}`);
                const snapshot = await get(tRef);
                if (!snapshot.exists()) throw new Error("Tournament not found.");
                
                const tData = snapshot.val();
                
                // টুর্নামেন্টের ট্যাগ থেকে টিমের আকার নির্ধারণ করা হচ্ছে
                const tags = (Array.isArray(tData.tags) ? tData.tags : Object.values(tData.tags || {})).map(tag => String(tag).toLowerCase());
                let teamSize = 1; 
                if (tags.includes('squad')) teamSize = 4;
                else if (tags.includes('duo')) teamSize = 2;
                
                // শুধুমাত্র দেখার জন্য সিট সিলেকশন মোডাল কল করা হচ্ছে
                setupSeatSelectionModal(tId, tData, teamSize, 'View', true); 

            } catch (error) {
                console.error("Error viewing team:", error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoader(false);
            }
        }

        async function handleViewResultsClick(event) {
            console.log("View Results Clicked");
            if (!elements.matchDetailsModalInstance) return;
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;

            elements.matchDetailsModalTitle.textContent = 'Loading Results...';
            elements.matchDetailsModalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
            elements.matchDetailsModalInstance.show();

            try {
                const tRef = ref(db, `tournaments/${tId}`);
                const snapshot = await get(tRef);

                if (!snapshot.exists()) {
                    throw new Error("Tournament not found.");
                }
                
                const t = snapshot.val();
                elements.matchDetailsModalTitle.textContent = `Results: ${t.name || 'Tournament'}`;

                if (!t.results || Object.keys(t.results).length === 0) {
                    throw new Error("Results are not available for this tournament yet.");
                }

                // Convert results object to an array and sort by total winnings
                const resultsArray = Object.values(t.results)
                    .filter(player => player.totalWinnings > 0) // Only show players who won something
                    .sort((a, b) => b.totalWinnings - a.totalWinnings);

                if (resultsArray.length === 0) {
                     elements.matchDetailsModalBody.innerHTML = '<p class="text-center text-secondary p-4">No prize winners for this tournament.</p>';
                     return;
                }

                let bodyHTML = '<h5>🏆 Winners List</h5>';
                bodyHTML += '<div class="table-responsive"><table class="table table-dark table-sm mt-3">';
                bodyHTML += '<thead><tr><th>Rank</th><th>Player (IGN)</th><th>Kills</th><th>Winnings</th></tr></thead><tbody>';

                resultsArray.forEach((player, index) => {
                    bodyHTML += `
                        <tr>
                            <td><strong>#${index + 1}</strong></td>
                            <td>${player.inGameName || 'N/A'}</td>
                            <td>${player.kills || 0}</td>
                            <td><strong class="text-accent">₹${(player.totalWinnings || 0).toFixed(2)}</strong></td>
                        </tr>
                    `;
                });
                
                bodyHTML += '</tbody></table></div>';
                elements.matchDetailsModalBody.innerHTML = bodyHTML;

            } catch (e) {
                console.error("Result load failed:", e);
                elements.matchDetailsModalBody.innerHTML = `<p class="text-danger text-center p-4">${e.message}</p>`;
            }
        }
 async function handleMatchDetailsClick(event) {
    console.log("Match Details Clicked");
     if (!elements.matchDetailsModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return;
     elements.matchDetailsModalTitle.textContent = 'Loading...'; elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>';
     elements.matchDetailsModalInstance.show();
     try {
         const tRef = ref(db, `tournaments/${tId}`);
         const s = await get(tRef);
         if (s.exists()) {
             const t = s.val();
             const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A';
             const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short'}) : 'TBA';
             let pDistHTML = '';
             if (t.prizeDistribution) {
                 let fmtDist = '';
                 if (typeof t.prizeDistribution === 'object') {
                     fmtDist = Object.entries(t.prizeDistribution)
                                  .map(([rank, prize]) => `Rank ${rank}: ₹${prize}`)
                                  .join('\n');
                 } else {
                     fmtDist = String(t.prizeDistribution).replace(/\\n/g, '\n');
                 }
                 pDistHTML = `<h5>Prize Distribution:</h5><pre>${fmtDist}</pre>`;
             }
             const desc = t.description || 'Standard rules apply.';
             const fmtDesc = desc.replace(/\n/g, '<br>');
             elements.matchDetailsModalTitle.textContent = t.name || 'Match Details';
             elements.matchDetailsModalBody.innerHTML = `<p><strong>Game:</strong> ${gName}</p><p><strong>Mode:</strong> ${t.mode || 'N/A'}</p><p><strong>Map:</strong> ${t.map || 'N/A'}</p><p><strong>Starts:</strong> ${sTimeLoc}</p><hr><p><strong>Entry:</strong> ${t.entryFee > 0 ? `₹${t.entryFee}` : 'Free'}</p><p><strong>Prize:</strong> ₹${t.prizePool || 0}</p><p><strong>Per Kill:</strong> ₹${t.perKillPrize || 0}</p><p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p><hr><h5>Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>${pDistHTML}`;
         } else elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>';
     } catch (e) { console.error("Details load failed:", e); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; }
 }

    async function handleIdPasswordClick(event) {
        if (!elements.idPasswordModalInstance) return;
        const tId = event.currentTarget.dataset.tournamentId;
        if (!tId) return;
        if (!currentUser || !userProfile?.joinedTournaments?.[tId]) {
            alert("Join the tournament first or refresh the page.");
            return;
        }
        // Reset modal state
        elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
        elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';
        // Gemini: ফটো কন্টেইনার রিসেট করা হচ্ছে
        if (elements.roomIdPassImageContainer) elements.roomIdPassImageContainer.style.display = 'none';
        if (elements.roomIdPassImage) elements.roomIdPassImage.src = '';
        
        elements.idPasswordModalInstance.show();
        try {
            const tournamentRef = ref(db, `tournaments/${tId}`);
            const s = await get(tournamentRef);
            removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
            removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
            if (s.exists()) {
                const tournamentData = s.val();
                if (tournamentData.showIdPass) {
                    elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet';
                    elements.roomPasswordDisplay.textContent = tournamentData.roomPassword || 'Not updated yet';
                } else {
                    elements.roomIdDisplay.textContent = 'Hidden by Admin';
                    elements.roomPasswordDisplay.textContent = 'Hidden by Admin';
                }

                // Gemini: এখানে ফটো দেখানোর জন্য নতুন কোড যোগ করা হয়েছে
                if (tournamentData.roomImageUrl && elements.roomIdPassImage && elements.roomIdPassImageContainer) {
                    elements.roomIdPassImage.src = tournamentData.roomImageUrl;
                    elements.roomIdPassImageContainer.style.display = 'block';
                }

            } else {
                elements.roomIdDisplay.textContent = 'Not Found';
                elements.roomPasswordDisplay.textContent = 'Not Found';
            }
        } catch (e) {
            console.error("ID/Pass fetch error:", e);
            removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
            removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
            elements.roomIdDisplay.textContent = 'Error';
            elements.roomPasswordDisplay.textContent = 'Error';
            alert("Error loading ID/Password. Check permissions or network.");
        }
    }


 async function handlePolicyClick(event) {
     if (!elements.policyModalInstance) return;
     event.preventDefault();
     const target = event.currentTarget;
     const policyType = target.dataset.policy;
     if (!policyType) return;

     let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';
     elements.policyModalBody.innerHTML = modalBodyContent;

     switch (policyType) {
         case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break;
         case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break;
         case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break;
         case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break;
         case 'refer':
             title = 'Refer & Earn';
             if (!currentUser) { alert("Login to view referral."); return; }
             const refCode = userProfile.referralCode || 'N/A';
             const refBonus = appSettings?.referralBonus || 0;
             const refDesc = appSettings?.referralDescription || `Get ₹${refBonus} when your friend joins using your code.`;
             modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${refDesc}</p></div>`;
             break;
         default:
             title = 'Info';
             modalBodyContent = '<p>Content unavailable.</p>';
     }

     elements.policyModalTitle.textContent = title;
     if (typeof modalBodyContent === 'string' && policyType !== 'refer') {
         elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>');
     } else {
         elements.policyModalBody.innerHTML = modalBodyContent;
     }
     elements.policyModalInstance.show();
 }
 
function handleAddAmountClick() {
    if (!currentUser) {
        alert("Please login to add funds.");
        showSection('login-section');
        return;
    }

    elements.qrSection.style.display = 'none';
    elements.paymentScreenshotInput.value = '';
    clearStatusMessage(elements.paymentStatusMessage);

    const fixedAmounts = [20, 50, 100, 500, 1000]; 
    elements.addAmountOptionsContainer.innerHTML = ''; 

    fixedAmounts.forEach(amount => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-custom btn-custom-accent';
        btn.textContent = `₹${amount}`;
        btn.onclick = () => showPaymentQR(amount);
        elements.addAmountOptionsContainer.appendChild(btn);
    });

    elements.addAmountModalInstance.show();
}

function showPaymentQR(amount) {
    const upiId = appSettings.upiDetails;
    const upiName = appSettings.appName || 'Payment';

    if (!upiId) {
        alert("Payment details are not configured by the admin yet. Please try again later.");
        console.error("UPI ID not found in appSettings.upiDetails");
        return;
    }

    const upiLink = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(upiName)}&am=${amount}&cu=INR`;
    
    currentPaymentSubmission.amount = amount;
    elements.selectedAmountDisplay.textContent = `₹${amount}`;
    elements.upiIdDisplay.textContent = upiId;

    if (typeof QRious === 'undefined') {
        console.error("QRious library not found!");
        alert("Error: QR Code generator failed to load.");
        return;
    }

    if (!qrInstance) {
        qrInstance = new QRious({
            element: elements.qrCanvasDisplay,
            value: upiLink,
            size: 200,
            padding: 10,
            level: 'H'
        });
    } else {
        qrInstance.value = upiLink;
    }

    elements.qrSection.style.display = 'block';
}


async function submitPaymentForVerification() {
    const file = elements.paymentScreenshotInput.files[0];
    const amount = currentPaymentSubmission.amount;

    if (!file) {
        showStatusMessage(elements.paymentStatusMessage, 'Please select a screenshot file.', 'warning');
        return;
    }
    if (amount <= 0) {
        showStatusMessage(elements.paymentStatusMessage, 'Invalid amount selected.', 'warning');
        return;
    }
    
    elements.submitPaymentBtn.disabled = true;
    elements.submitPaymentBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

    try {
        const imageUrl = await uploadToImgBB(file);
        
        const paymentRequestRef = ref(db, 'paymentRequests');
        const newRequest = {
            userId: currentUser.uid,
            userName: userProfile.displayName || currentUser.email,
            amount: amount,
            screenshotUrl: imageUrl,
            status: 'pending',
            requestTimestamp: serverTimestamp(),
        };
        await push(paymentRequestRef, newRequest);
        
        showStatusMessage(elements.paymentStatusMessage, 'Submitted! Admin will verify and add balance soon.', 'success', false);
        setTimeout(() => {
            elements.addAmountModalInstance.hide();
        }, 3000);

    } catch (error) {
        console.error("Payment submission failed:", error);
        showStatusMessage(elements.paymentStatusMessage, `Error: ${error.message}`, 'danger');
    } finally {
        elements.submitPaymentBtn.disabled = false;
        elements.submitPaymentBtn.innerHTML = 'Submit for Verification';
    }
}


// --- Realtime Listeners Setup ---
 function setupRealtimeListeners(uid) {
     if (!uid || !db || !currentUser) return;
     detachAllDbListeners();
     console.log("Setting up realtime listener for User Profile:", uid);
     const uRef = ref(db, `users/${uid}`);
     const listFunc = onValue(uRef, (s) => {
         if (currentUser && currentUser.uid === uid) {
             if (s.exists()) {
                 console.log("Realtime: User Profile Update Received");
                 userProfile = s.val();
                 populateUserInfo(currentUser, userProfile);
                 if (currentSectionId === 'home-section') loadMyContests();
                 if (currentSectionId === 'wallet-section') loadRecentTransactions();
                 if (currentSectionId === 'transactions-section') loadAllTransactions();
                 if (currentSectionId === 'my-contests-section') loadDedicatedMyContests();
             } else {
                 console.warn("User data deleted (realtime) for:", uid);
                 alert("Account data missing or deleted. Logging out.");
                 logoutUser();
             }
         } else {
             console.log("Realtime listener fired for a different user or logged-out state. Detaching.");
             off(uRef, 'value', listFunc);
         }
     }, (e) => {
         console.error("Listener error (user profile):", e);
     });
     dbListeners['userProfile'] = { path: `users/${uid}`, func: listFunc };
 }

 function detachAllDbListeners() {
     console.log("Detaching listeners:", Object.keys(dbListeners));
     let count = 0;
     for (const k in dbListeners) {
         try {
             const { path, func } = dbListeners[k];
             if (path && func) {
                  off(ref(db, path), 'value', func);
                  count++;
             } else {
                 console.warn(`Listener object invalid for key: ${k}`);
             }
         } catch (e) { console.error(`Detach error ${k}:`, e); }
     }
     dbListeners = {};
     console.log(`Detached ${count} listeners.`);
 }

// --- Security Rules Check ---
 async function checkSecurityRules() {
    console.log("Checking security rules...");
     try {
         if (!currentUser) {
             console.log("Security rule check skipped for anonymous user (rely on console).");
         } else if (elements.securityWarning) {
              elements.securityWarning.style.display = 'none';
         }
     } catch (error) {
         console.log("Security rule check result (expected failure if secure):", error.message);
         if (elements.securityWarning) elements.securityWarning.style.display = 'none';
     }
 }

// --- Event Listeners Initialization ---
 function initializeEventListeners() {
     if (!elements) return; console.log("Initializing listeners...");
     elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); }));
     elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
     elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (currentTournamentGameId && s) { elements.tournamentTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); filterTournaments(currentTournamentGameId, s); } }));

     elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
     elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
     elements.googleSignInBtn?.addEventListener('click', signInWithGoogle);
     elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
     elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
     elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });

     elements.logoutProfileBtn?.addEventListener('click', logoutUser);
     elements.editProfileNameBtn?.addEventListener('click', handleEditProfileName);
     elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
     elements.notificationSwitch?.addEventListener('change', (e) => { console.log("Notification toggle:", e.target.checked); });

     elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
     elements.addAmountWalletBtn?.addEventListener('click', handleAddAmountClick);
     elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
     elements.submitPaymentBtn?.addEventListener('click', submitPaymentForVerification);

     // Gemini: Add event listeners for the new "Send to Friend" feature
     elements.sendToFriendBtn?.addEventListener('click', handleSendToFriendClick);
     elements.confirmSendToFriendBtn?.addEventListener('click', confirmSendToFriendHandler);

     elements.notificationBtn?.addEventListener('click', () => alert('Notifications coming soon!'));
     elements.allTransactionsBtn?.addEventListener('click', () => showSection('transactions-section')); // MODIFIED
     
     // ===== লিডারবোর্ড ট্যাবের জন্য নতুন লিসেনার =====
     const leaderboardTabs = document.querySelectorAll('#leaderboardTabs .nav-link');
     leaderboardTabs.forEach(tab => {
         tab.addEventListener('click', (event) => {
             leaderboardTabs.forEach(t => t.classList.remove('active'));
             event.currentTarget.classList.add('active');
             const period = event.currentTarget.dataset.period;
             loadLeaderboardData(period);
         });
     });

     document.body.addEventListener('click', (event) => {
        if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) {
            const btn = event.target.closest('.copy-btn');
            const targetSelector = btn.dataset.target;
            if (targetSelector) {
                copyToClipboard(targetSelector);
            } else {
                console.warn("Copy button missing data-target selector.");
            }
        }
        if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) {
            const cel = getElement('referralCodeDisplay');
            if (cel) shareReferral(cel.textContent);
        }
        // --- Gemini: 'View Team' বাটনের জন্য নতুন ইভেন্ট হ্যান্ডলার ---
        const viewTeamBtn = event.target.closest('.btn-view-team');
        if (viewTeamBtn) {
            handleViewTeamClick(event);
        }
     });
     
    // --- Gemini: Added for Password Visibility Toggle ---
    document.body.addEventListener('click', function(event) {
        const toggleBtn = event.target.closest('.password-toggle-btn');
        if (toggleBtn) {
            const wrapper = toggleBtn.parentElement;
            const passwordInput = wrapper.querySelector('input');
            const icon = toggleBtn.querySelector('i');
            if (passwordInput) {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                }
            }
        }
    });
    console.log("Listeners initialized.");
 }

// --- App Initialization ---
 document.addEventListener('DOMContentLoaded', () => {
     console.log("DOM Loaded. Init App...");
     if (typeof initializeApp !== 'function' || !auth || !db) {
         console.error("Firebase SDK failed/not ready. Cannot proceed.");
         return;
     }
     showLoader(true);
     loadAppSettings()
         .then(() => {
             console.log("Settings loaded, initializing listeners and auth state...");
             initializeEventListeners();
             updateGlobalUI(false);
             onAuthStateChanged(auth, handleAuthStateChange);
         })
         .catch(err => {
             console.error("CRITICAL: Initial settings load failed:", err);
             alert("Error loading essential app settings. Please try again later.");
             initializeEventListeners();
             updateGlobalUI(false);
             onAuthStateChanged(auth, handleAuthStateChange);
         })
         .finally(() => {
            // Loader is hidden inside handleAuthStateChange
         });
 });

</script>
</body>
</html>
